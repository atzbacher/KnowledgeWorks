<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>KnowledgeWorks PDF Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf_viewer.min.css"
      referrerpolicy="no-referrer"
    />
    <style>
      :root {
        color-scheme: light dark;
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #1e1e1e;
        color: #f5f5f5;
        display: flex;
      }

      #app {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 0;
      }

      header {
        padding: 10px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        background-color: #2d2d2d;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      header h1 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
      }

      #status {
        font-size: 14px;
        opacity: 0.85;
      }

      #viewerContainer {
        flex: 1;
        position: relative;
        overflow: auto;
        background-color: #1e1e1e;
      }

      #viewer {
        padding: 16px 0;
      }

      .pdfViewer .page {
        margin: 0 auto 12px auto;
        box-shadow: 0 4px 18px rgba(0, 0, 0, 0.45);
        border-radius: 4px;
        overflow: hidden;
      }

      .error {
        color: #ff7777;
      }
    </style>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf_viewer.min.js"
      referrerpolicy="no-referrer"
    ></script>
  </head>
  <body tabindex="1">
    <div id="app">
      <header>
        <h1>KnowledgeWorks PDF Viewer</h1>
        <span id="status">Waiting for document…</span>
      </header>
      <div id="viewerContainer" class="viewerContainer">
        <div id="viewer" class="pdfViewer"></div>
      </div>
    </div>
    <script>
      (function () {
        const statusEl = document.getElementById("status");
        const viewerContainer = document.getElementById("viewerContainer");
        const params = new URLSearchParams(window.location.search);
        const initialUrl = params.get("file");

        if (!window.pdfjsLib || !window.pdfjsViewer) {
          statusEl.textContent = "PDF.js is unavailable.";
          statusEl.classList.add("error");
          return;
        }

        const { AnnotationEditorType, AnnotationMode, TextLayerMode } =
          window.pdfjsLib;
        const { EventBus, PDFLinkService, PDFFindController, PDFViewer } =
          window.pdfjsViewer;

        pdfjsLib.GlobalWorkerOptions.workerSrc =
          "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js";

        const eventBus = new EventBus();
        const linkService = new PDFLinkService({ eventBus });
        const findController = new PDFFindController({
          eventBus,
          linkService,
        });

        const pdfViewer = new PDFViewer({
          container: viewerContainer,
          eventBus,
          linkService,
          findController,
          textLayerMode: TextLayerMode?.ENABLE ?? 1,
          annotationMode: AnnotationMode?.ENABLE ?? 3,
          annotationEditorMode: AnnotationEditorType?.HIGHLIGHT ?? 3,
          enableHighlightFloatingButton: true,
        });

        linkService.setViewer(pdfViewer);

        const initializedPromise = Promise.resolve();

        const app = {
          eventBus,
          pdfViewer,
          linkService,
          findController,
          initializedPromise,
          pdfDocument: null,
          url: null,
          appConfig: {
            mainContainer: viewerContainer,
            viewerContainer,
          },
          async open(options) {
            const target = typeof options === "string" ? options : options?.url;
            if (!target) {
              return null;
            }

            await this.close();
            statusEl.classList.remove("error");
            statusEl.textContent = "Loading document…";

            try {
              const loadingTask = pdfjsLib.getDocument({
                url: target,
                withCredentials: false,
              });

              const pdfDocument = await loadingTask.promise;
              this.pdfDocument = pdfDocument;
              this.url = target;

              pdfViewer.setDocument(pdfDocument);
              linkService.setDocument(pdfDocument, null);

              eventBus.dispatch("documentloaded", { source: this });

              if (
                AnnotationEditorType &&
                pdfViewer.annotationEditorMode !== AnnotationEditorType.DISABLE
              ) {
                try {
                  pdfViewer.annotationEditorMode = {
                    mode: AnnotationEditorType.HIGHLIGHT,
                    mustEnterInEditMode: false,
                  };
                } catch (error) {
                  console.warn("Unable to enable highlight editor", error);
                }
              }

              statusEl.classList.remove("error");
              statusEl.textContent = `Page 1 of ${pdfDocument.numPages}`;
              return pdfDocument;
            } catch (error) {
              console.error("Failed to open PDF", error);
              statusEl.textContent = "Unable to load document.";
              statusEl.classList.add("error");
              throw error;
            }
          },
          async close() {
            if (!this.pdfDocument) {
              return;
            }

            const previous = this.pdfDocument;
            try {
              pdfViewer.setDocument(null);
              linkService.setDocument(null, null);
              findController.setDocument(null);
              await previous.destroy();
            } catch (error) {
              console.warn("Failed to destroy previous document", error);
            }

            this.pdfDocument = null;
            this.url = null;
            pdfViewer.cleanup();
          },
        };

        window.PDFViewerApplication = app;

        eventBus.on("pagesinit", () => {
          pdfViewer.currentScaleValue = "page-width";
        });

        eventBus.on("pagechanging", evt => {
          if (app.pdfDocument) {
            statusEl.textContent = `Page ${evt?.pageNumber ?? 1} of ${app.pdfDocument.numPages}`;
          }
        });

        eventBus.on("documentloaded", () => {
          if (app.pdfDocument) {
            statusEl.textContent = `Page 1 of ${app.pdfDocument.numPages}`;
          }
        });

        if (initialUrl) {
          initializedPromise
            .then(() => app.open({ url: initialUrl, originalUrl: initialUrl }))
            .catch(error => {
              console.error("Failed to load initial PDF", error);
              statusEl.textContent = "Unable to load document.";
              statusEl.classList.add("error");
            });
        }
      })();
    </script>
    <script src="./knowledgeworks-bridge.js"></script>
  </body>
</html>
