<UserControl x:Class="LM.App.Wpf.Views.AddView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="1000">
  <DockPanel>
    <!-- Toolbar -->
    <StackPanel Orientation="Horizontal" DockPanel.Dock="Top" Margin="12">
      <Button Content="Add file..." Command="{Binding AddFilesCommand}"/>
      <Button Content="Bulk add folder..." Command="{Binding BulkAddFolderCommand}"/>
      <Button Content="Review staged…" Click="OnReviewStaged"/>
      <Button Content="Commit selected" Command="{Binding CommitSelectedCommand}"/>
      <Button Content="Clear" Command="{Binding ClearCommand}"/>
    </StackPanel>

    <!-- Watched folders management -->
    <Border DockPanel.Dock="Top" Margin="12,0,12,12" Padding="12" Background="#FFF8F8F8" CornerRadius="4">
      <StackPanel>
        <DockPanel>
          <TextBlock Text="Watched folders" FontWeight="Bold" FontSize="14" VerticalAlignment="Center"/>
          <Button Content="Add watched folder..."
                  Command="{Binding AddWatchedFolderCommand}"
                  DockPanel.Dock="Right"
                  HorizontalAlignment="Right"/>
        </DockPanel>

        <ListView ItemsSource="{Binding WatchedFolders}" Margin="0,8,0,0" BorderThickness="0">
          <ListView.Style>
            <Style TargetType="ListView">
              <Setter Property="Visibility" Value="Visible"/>
              <Style.Triggers>
                <DataTrigger Binding="{Binding WatchedFolders.Count}" Value="0">
                  <Setter Property="Visibility" Value="Collapsed"/>
                </DataTrigger>
              </Style.Triggers>
            </Style>
          </ListView.Style>
          <ListView.View>
            <GridView>
              <GridViewColumn Width="80" Header="Enabled">
                <GridViewColumn.CellTemplate>
                  <DataTemplate>
                    <CheckBox IsChecked="{Binding IsEnabled, Mode=TwoWay}" HorizontalAlignment="Center"/>
                  </DataTemplate>
                </GridViewColumn.CellTemplate>
              </GridViewColumn>
              <GridViewColumn Width="320" Header="Folder">


                <GridViewColumn.DisplayMemberBinding>
                  <Binding Path="Path"/>
                </GridViewColumn.DisplayMemberBinding>
              </GridViewColumn>
              <GridViewColumn Width="160" Header="Last scan">
                <GridViewColumn.CellTemplate>
                  <DataTemplate>
                    <TextBlock Text="{Binding LastScanDisplay}"/>
                  </DataTemplate>
                </GridViewColumn.CellTemplate>
              </GridViewColumn>
              <GridViewColumn Width="200">
                <GridViewColumn.CellTemplate>
                  <DataTemplate>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                      <Button Content="Scan now"
                              Command="{Binding DataContext.ScanWatchedFolderCommand, RelativeSource={RelativeSource AncestorType=ListView}}"
                              CommandParameter="{Binding}"
                              Margin="0,0,6,0"/>
                      <Button Content="Remove"
                              Command="{Binding DataContext.RemoveWatchedFolderCommand, RelativeSource={RelativeSource AncestorType=ListView}}"
                              CommandParameter="{Binding}"/>
                    </StackPanel>
                  </DataTemplate>
                </GridViewColumn.CellTemplate>
              </GridViewColumn>
            </GridView>
          </ListView.View>
        </ListView>

        <TextBlock Text="No watched folders configured." Foreground="Gray" FontStyle="Italic" HorizontalAlignment="Center" Margin="0,8,0,0">
          <TextBlock.Style>
            <Style TargetType="TextBlock">
              <Setter Property="Visibility" Value="Collapsed"/>
              <Style.Triggers>
                <DataTrigger Binding="{Binding WatchedFolders.Count}" Value="0">
                  <Setter Property="Visibility" Value="Visible"/>
                </DataTrigger>
              </Style.Triggers>
            </Style>
          </TextBlock.Style>
        </TextBlock>
      </StackPanel>
    </Border>

          <!-- Staging grid -->
          <DataGrid ItemsSource="{Binding Staging}"
                                SelectedItem="{Binding Current, Mode=TwoWay}"
                IsSynchronizedWithCurrentItem="True"
                Margin="12"
				IsReadOnly="False"
				CanUserAddRows="False"
				MouseDoubleClick="OnRowDoubleClick">

		  <!-- Row visuals: grey-out exact duplicates, amber for near matches -->
		  <DataGrid.RowStyle>
			  <Style TargetType="DataGridRow">
				  <Setter Property="Opacity" Value="1"/>
				  <Setter Property="IsEnabled" Value="True"/>
				  <Style.Triggers>
					  <!-- Exact duplicate: dim + disable -->
					  <DataTrigger Binding="{Binding IsDuplicate}" Value="True">
						  <Setter Property="Opacity" Value="0.5"/>
						  <Setter Property="IsEnabled" Value="False"/>
						  <Setter Property="Background" Value="#FFF0F0F0"/>
					  </DataTrigger>

					  <!-- Near match: amber background (still editable) -->
					  <DataTrigger Binding="{Binding IsNearMatch}" Value="True">
						  <Setter Property="Background" Value="#FFFDEEB5"/>
					  </DataTrigger>
				  </Style.Triggers>
			  </Style>
		  </DataGrid.RowStyle>

		  <DataGrid.Columns>
			  <!-- ✓ column: disable the checkbox for exact duplicates -->
			  <DataGridCheckBoxColumn Header="✓"
									  Binding="{Binding Selected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
									  Width="35">
				  <DataGridCheckBoxColumn.ElementStyle>
					  <Style TargetType="CheckBox">
						  <Setter Property="HorizontalAlignment" Value="Center"/>
						  <Style.Triggers>
							  <DataTrigger Binding="{Binding IsDuplicate}" Value="True">
								  <Setter Property="IsEnabled" Value="False"/>
							  </DataTrigger>
						  </Style.Triggers>
					  </Style>
				  </DataGridCheckBoxColumn.ElementStyle>
				  <DataGridCheckBoxColumn.EditingElementStyle>
					  <Style TargetType="CheckBox">
						  <Setter Property="HorizontalAlignment" Value="Center"/>
						  <Style.Triggers>
							  <DataTrigger Binding="{Binding IsDuplicate}" Value="True">
								  <Setter Property="IsEnabled" Value="False"/>
							  </DataTrigger>
						  </Style.Triggers>
					  </Style>
				  </DataGridCheckBoxColumn.EditingElementStyle>
			  </DataGridCheckBoxColumn>

			  <DataGridTextColumn Header="File" Binding="{Binding OriginalFileName}" Width="1.5*"/>
			  <DataGridTextColumn Header="Title" Binding="{Binding Title}" Width="2*"/>
			  <DataGridTextColumn Header="Display name" Binding="{Binding DisplayName}" Width="1.5*"/>
			  <DataGridTextColumn Header="Authors" Binding="{Binding AuthorsCsv}" Width="2*"/>
			  <DataGridTextColumn Header="Year" Binding="{Binding Year}" Width="70"/>
			  <DataGridTextColumn Header="Source" Binding="{Binding Source}" Width="1.2*"/>
			  <DataGridTextColumn Header="Tags" Binding="{Binding TagsCsv}" Width="1.2*"/>
			  <DataGridCheckBoxColumn Header="Internal" Binding="{Binding IsInternal}" Width="80"/>
			  <DataGridTextColumn Header="DOI" Binding="{Binding Doi}" Width="1.5*"/>
			  <DataGridTextColumn Header="PMID" Binding="{Binding Pmid}" Width="1.2*"/>
			  <DataGridTextColumn Header="Similar to" Binding="{Binding SimilarToTitle}" Width="2*"/>
			  <DataGridTextColumn Header="Similarity" Binding="{Binding Similarity, StringFormat={}{0:P0}}" Width="100"/>
                <!-- User can type/paste the EntryId to attach to -->
                <DataGridTextColumn Header="Attach to (EntryId)" Binding="{Binding AttachToEntryId, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="1.6*" />

                <!-- Read-only display of target title if we fill it, else show the best match -->
                <DataGridTextColumn Header="Attach title" Binding="{Binding SimilarToTitle}" Width="2*" />
                <DataGridComboBoxColumn Header="Action" SelectedItemBinding="{Binding SuggestedAction}" Width="130">
				  <DataGridComboBoxColumn.ItemsSource>
					  <x:Array Type="{x:Type sys:String}" xmlns:sys="clr-namespace:System;assembly=mscorlib">
						  <sys:String>New</sys:String>
						  <sys:String>Version</sys:String>
						  <sys:String>Variant</sys:String>
						  <sys:String>Attachment</sys:String>
						  <sys:String>Skip</sys:String>
					  </x:Array>
				  </DataGridComboBoxColumn.ItemsSource>
			  </DataGridComboBoxColumn>
		  </DataGrid.Columns>
	  </DataGrid>
  </DockPanel>
</UserControl>
