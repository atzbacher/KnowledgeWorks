<UserControl x:Class="LM.App.Wpf.Views.LibraryView"
             x:Name="LibraryViewControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
             xmlns:behaviors="clr-namespace:LM.App.Wpf.Views.Behaviors"
             xmlns:converters="clr-namespace:LM.App.Wpf.Views.Converters"
             xmlns:viewModels="clr-namespace:LM.App.Wpf.ViewModels.Library"
             xmlns:sys="clr-namespace:System;assembly=mscorlib"
             xmlns:controls="clr-namespace:LM.App.Wpf.Views.Library.Controls"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="900">
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="Library/LibraryCommonResources.xaml" />
                <ResourceDictionary Source="Library/LibraryThemeResources.xaml" />
                <ResourceDictionary Source="Library/LibraryEntryDetailTemplate.xaml" />
                <ResourceDictionary Source="Templates/LibraryResultsColumns.xaml" />
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </UserControl.Resources>

    <Grid Background="#F6F6F6">
        <Border Margin="0"
            Background="#FFFFFF"
            BorderBrush="#D1D5DB"
            BorderThickness="1">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="{Binding DataContext.Filters.LeftPanelWidth, ElementName=LibraryViewControl, Mode=TwoWay}" MinWidth="0"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="{Binding DataContext.Filters.RightPanelWidth, ElementName=LibraryViewControl, Mode=TwoWay}" MinWidth="0"/>
                </Grid.ColumnDefinitions>

                <!-- Compact Search header -->
                <Border Grid.Row="0"
                Grid.Column="0"
                Grid.ColumnSpan="5"
                Background="#FAFAFA"
                BorderBrush="#E5E7EB"
                BorderThickness="0,0,0,1"
                Padding="8,6">
                    <StackPanel DataContext="{Binding Filters}">
                        <DockPanel>
                            <StackPanel Orientation="Horizontal" DockPanel.Dock="Right">
                                <Button Style="{StaticResource LibraryHeaderButtonStyle}"
                        Content="Save search"
                        Command="{Binding SaveSearchCommand}"
                        Margin="0,0,4,0"/>
                                <Button Style="{StaticResource LibraryHeaderButtonStyle}"
                        Content="Clear"
                        Command="{Binding ClearSearchCommand}"/>
                            </StackPanel>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" MaxWidth="500"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBox Grid.Column="0"
                         Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}"
                         Style="{StaticResource LibrarySearchFieldStyle}"
                         Height="26"
                         VerticalContentAlignment="Center"/>
                                <ComboBox Grid.Column="1"
                          Margin="4,0,0,0"
                          MinWidth="100"
                          Height="26"
                          ItemsSource="{Binding SortOptions}"
                          SelectedItem="{Binding SelectedSort}"/>
                                <CheckBox Grid.Column="2"
                          Content="Full text"
                          Margin="8,0,0,0"
                          VerticalAlignment="Center"
                          IsChecked="{Binding IsFullTextSearchEnabled}"/>
                            </Grid>
                        </DockPanel>
                    </StackPanel>
                </Border>

                <!-- Left Panel - Collections/Tags (Zotero-style) -->
                <Border Grid.Row="1"
                Grid.Column="0"
                Background="#F8F9FA"
                BorderBrush="#E5E7EB"
                BorderThickness="0,0,1,0">
                    <Border.Style>
                        <Style TargetType="Border">
                            <Setter Property="Visibility" Value="Visible"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding DataContext.Filters.IsLeftPanelCollapsed, ElementName=LibraryViewControl}" Value="True">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>
                    <ScrollViewer VerticalScrollBarVisibility="Auto"
                        HorizontalScrollBarVisibility="Disabled"
                        DataContext="{Binding Filters}">
                        <StackPanel Margin="8">
                            <!-- Saved Searches -->
                            <Border Background="White"
                      BorderBrush="#E5E7EB"
                      BorderThickness="1"
                      CornerRadius="3"
                      Margin="0,0,0,8">
                                <StackPanel>
                                    <Border Background="#F3F4F6"
                          BorderBrush="#E5E7EB"
                          BorderThickness="0,0,0,1"
                          Padding="6,4">
                                        <TextBlock Text="SAVED SEARCHES"
                               FontSize="11"
                               FontWeight="SemiBold"
                               Foreground="#6B7280"/>
                                    </Border>
                                    <ItemsControl ItemsSource="{Binding Presets}"
                                Margin="0">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Button Style="{StaticResource LibraryPresetButtonStyle}"
                                Command="{Binding DataContext.Filters.LoadPresetCommand, ElementName=LibraryViewControl}"
                                CommandParameter="{Binding}"
                                HorizontalContentAlignment="Left"
                                Padding="8,4"
                                BorderThickness="0">
                                                    <TextBlock Text="{Binding Name}" TextTrimming="CharacterEllipsis"/>
                                                </Button>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </Border>

                            <!-- Tags Filter -->
                            <Border Background="White"
                      BorderBrush="#E5E7EB"
                      BorderThickness="1"
                      CornerRadius="3"
                      Margin="0,0,0,8">
                                <StackPanel>
                                    <Border Background="#F3F4F6"
                          BorderBrush="#E5E7EB"
                          BorderThickness="0,0,0,1"
                          Padding="6,4">
                                        <TextBlock Text="TAGS"
                               FontSize="11"
                               FontWeight="SemiBold"
                               Foreground="#6B7280"/>
                                    </Border>
                                    <ListBox ItemsSource="{Binding SelectedTags}"
                           Margin="4"
                           MinHeight="60"
                           MaxHeight="150"
                           BorderThickness="1"
                           BorderBrush="#E5E7EB">
                                        <ListBox.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel/>
                                            </ItemsPanelTemplate>
                                        </ListBox.ItemsPanel>
                                        <ListBox.ItemTemplate>
                                            <DataTemplate>
                                                <Border Background="#E0E7FF"
                                BorderBrush="#6366F1"
                                BorderThickness="1"
                                CornerRadius="2"
                                Padding="4,2"
                                Margin="2">
                                                    <StackPanel Orientation="Horizontal">
                                                        <TextBlock Text="{Binding}"
                                       FontSize="11"
                                       Foreground="#4338CA"
                                       Margin="0,0,4,0"/>
                                                        <Button Content="X"
                                    Command="{Binding DataContext.Filters.RemoveTagCommand, ElementName=LibraryViewControl}"
                                    CommandParameter="{Binding}"
                                    Background="Transparent"
                                    BorderThickness="0"
                                    Padding="0"
                                    Width="12"
                                    Height="12"
                                    FontSize="12"
                                    Foreground="#4338CA"/>
                                                    </StackPanel>
                                                </Border>
                                            </DataTemplate>
                                        </ListBox.ItemTemplate>
                                    </ListBox>
                                </StackPanel>
                            </Border>

                            <!-- Date Filter -->
                            <Border Background="White"
                      BorderBrush="#E5E7EB"
                      BorderThickness="1"
                      CornerRadius="3"
                      Margin="0,0,0,8">
                                <StackPanel>
                                    <Border Background="#F3F4F6"
                          BorderBrush="#E5E7EB"
                          BorderThickness="0,0,0,1"
                          Padding="6,4">
                                        <TextBlock Text="DATE RANGE"
                               FontSize="11"
                               FontWeight="SemiBold"
                               Foreground="#6B7280"/>
                                    </Border>
                                    <StackPanel Margin="8,4">
                                        <DatePicker SelectedDate="{Binding DateFrom}"
                                Height="24"
                                Margin="0,2"/>
                                        <DatePicker SelectedDate="{Binding DateTo}"
                                Height="24"
                                Margin="0,2"/>
                                    </StackPanel>
                                </StackPanel>
                            </Border>

                            <!-- Full Text Options -->
                            <Border Background="White"
                      BorderBrush="#E5E7EB"
                      BorderThickness="1"
                      CornerRadius="3">
                                <StackPanel>
                                    <Border Background="#F3F4F6"
                          BorderBrush="#E5E7EB"
                          BorderThickness="0,0,0,1"
                          Padding="6,4">
                                        <TextBlock Text="FULL TEXT SEARCH"
                               FontSize="11"
                               FontWeight="SemiBold"
                               Foreground="#6B7280"/>
                                    </Border>
                                    <TextBox Text="{Binding FullTextQuery, UpdateSourceTrigger=PropertyChanged}"
                           Margin="4"
                           Height="24"
                           VerticalContentAlignment="Center"/>
                                    <WrapPanel Margin="4,0,4,4">
                                        <CheckBox Content="Title"
                              Margin="0,0,8,4"
                              IsChecked="{Binding FullTextInTitle}"/>
                                        <CheckBox Content="Abstract"
                              Margin="0,0,8,4"
                              IsChecked="{Binding FullTextInAbstract}"/>
                                        <CheckBox Content="Content"
                              Margin="0,0,8,4"
                              IsChecked="{Binding FullTextInContent}"/>
                                    </WrapPanel>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </ScrollViewer>
                </Border>

                <!-- Toggle Left Panel Button -->
                <Button Grid.Row="1"
                Grid.Column="1"
                Command="{Binding DataContext.Filters.ToggleLeftPanelCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                HorizontalAlignment="Left"
                VerticalAlignment="Top"
                Width="20"
                Height="32"
                Padding="0"
                Margin="2,8,2,0"
                FontFamily="Segoe MDL2 Assets"
                FontSize="12"
                Background="Transparent"
                BorderThickness="0">
                    <Button.Style>
                        <Style TargetType="Button" BasedOn="{StaticResource LibraryHeaderButtonStyle}">
                            <Setter Property="Content" Value="&#xE0E2;"/>
                            <Setter Property="ToolTip" Value="Hide collections panel"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding DataContext.Filters.IsLeftPanelCollapsed, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="True">
                                    <Setter Property="Content" Value="&#xE0E3;"/>
                                    <Setter Property="ToolTip" Value="Show collections panel"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <!-- Center - Results List (Compact Zotero-style) -->
                <DataGrid Grid.Row="1"
                  Grid.Column="2"
                  x:Name="ResultsList"
                  ItemsSource="{Binding Results.Items}"
                  SelectedItem="{Binding Results.Selected}"
                  AutoGenerateColumns="False"
                  CanUserAddRows="False"
                  CanUserDeleteRows="False"
                  GridLinesVisibility="Horizontal"
                  HorizontalGridLinesBrush="#E5E7EB"
                  BorderThickness="0"
                  Background="White"
                  RowHeight="24"
                  HeadersVisibility="Column">
                    <DataGrid.ColumnHeaderStyle>
                        <Style TargetType="DataGridColumnHeader">
                            <Setter Property="Background" Value="#F9FAFB"/>
                            <Setter Property="Foreground" Value="#374151"/>
                            <Setter Property="FontSize" Value="11"/>
                            <Setter Property="FontWeight" Value="SemiBold"/>
                            <Setter Property="Height" Value="28"/>
                            <Setter Property="BorderBrush" Value="#E5E7EB"/>
                            <Setter Property="BorderThickness" Value="0,0,1,1"/>
                            <Setter Property="Padding" Value="6,0"/>
                        </Style>
                    </DataGrid.ColumnHeaderStyle>
                    <DataGrid.CellStyle>
                        <Style TargetType="DataGridCell">
                            <Setter Property="BorderThickness" Value="0"/>
                            <Setter Property="Padding" Value="4,0"/>
                            <Setter Property="FontSize" Value="11"/>
                            <Style.Triggers>
                                <Trigger Property="IsSelected" Value="True">
                                    <Setter Property="Background" Value="#EFF6FF"/>
                                    <Setter Property="Foreground" Value="#1F2937"/>
                                    <Setter Property="BorderBrush" Value="#BFDBFE"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </DataGrid.CellStyle>
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Title" 
                                Binding="{Binding Entry.Title}" 
                                Width="2*">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
                                    <Setter Property="VerticalAlignment" Value="Center"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn Header="Authors" 
                                Binding="{Binding Entry.Authors}" 
                                Width="*">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
                                    <Setter Property="VerticalAlignment" Value="Center"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn Header="Year" 
                                Binding="{Binding Entry.Year}" 
                                Width="50"/>
                        <DataGridTextColumn Header="Journal" 
                                Binding="{Binding Entry.Journal}" 
                                Width="*">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
                                    <Setter Property="VerticalAlignment" Value="Center"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn Header="Added" 
                                Binding="{Binding Entry.DateAdded, StringFormat='{}{0:yyyy-MM-dd}'}" 
                                Width="80"/>
                    </DataGrid.Columns>
                </DataGrid>

                <!-- Toggle Right Panel Button -->
                <Button Grid.Row="1"
                Grid.Column="3"
                Command="{Binding DataContext.Filters.ToggleRightPanelCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                HorizontalAlignment="Right"
                VerticalAlignment="Top"
                Width="20"
                Height="32"
                Padding="0"
                Margin="2,8,2,0"
                FontFamily="Segoe MDL2 Assets"
                FontSize="12"
                Background="Transparent"
                BorderThickness="0">
                    <Button.Style>
                        <Style TargetType="Button" BasedOn="{StaticResource LibraryHeaderButtonStyle}">
                            <Setter Property="Content" Value="&#xE0E3;"/>
                            <Setter Property="ToolTip" Value="Hide details panel"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding DataContext.Filters.IsRightPanelCollapsed, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="True">
                                    <Setter Property="Content" Value="&#xE0E2;"/>
                                    <Setter Property="ToolTip" Value="Show details panel"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <!-- Right Panel - Entry Details -->
                <Border Grid.Row="1"
                Grid.Column="4"
                Background="White"
                BorderBrush="#E5E7EB"
                BorderThickness="1,0,0,0">
                    <Border.Style>
                        <Style TargetType="Border">
                            <Setter Property="Visibility" Value="Visible"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding DataContext.Filters.IsRightPanelCollapsed, ElementName=LibraryViewControl}" Value="True">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>
                    <ScrollViewer VerticalScrollBarVisibility="Auto"
                        HorizontalScrollBarVisibility="Disabled">
                        <Grid>
                            <ContentPresenter x:Name="EntryDetailPresenter"
                                Content="{Binding Results.SelectedEntry}"
                                ContentTemplate="{StaticResource LibraryEntryDetailTemplate}"
                                Margin="8"/>
                            <TextBlock Text="Select an entry to view details"
                         Margin="8"
                         FontStyle="Italic"
                         Foreground="#9CA3AF"
                         TextWrapping="Wrap"
                         VerticalAlignment="Center"
                         HorizontalAlignment="Center">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Content, ElementName=EntryDetailPresenter}" Value="{x:Null}">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </Grid>
                    </ScrollViewer>
                </Border>
            </Grid>
        </Border>
    </Grid>
</UserControl>