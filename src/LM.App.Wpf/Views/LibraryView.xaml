<UserControl x:Class="LM.App.Wpf.Views.LibraryView"
             x:Name="LibraryViewControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
             xmlns:behaviors="clr-namespace:LM.App.Wpf.Views.Behaviors"
             xmlns:converters="clr-namespace:LM.App.Wpf.Views.Converters"
             xmlns:viewModels="clr-namespace:LM.App.Wpf.ViewModels.Library"
             xmlns:sys="clr-namespace:System;assembly=mscorlib"
             xmlns:controls="clr-namespace:LM.App.Wpf.Views.Library.Controls"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"

             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="900">
  <UserControl.Resources>
    <ResourceDictionary>
      <ResourceDictionary.MergedDictionaries>
        <ResourceDictionary Source="Library/LibraryCommonResources.xaml" />
        <ResourceDictionary Source="Library/LibraryEntryDetailTemplate.xaml" />
        <ResourceDictionary Source="Templates/LibraryResultsColumns.xaml" />
      </ResourceDictionary.MergedDictionaries>
      <Style TargetType="controls:LibrarySearchQueryBox">
        <Setter Property="Background" Value="#FFECEFF2" />
        <Setter Property="BorderBrush" Value="#FFC4CAD0" />
        <Setter Property="BorderThickness" Value="1" />
        <Setter Property="Padding" Value="10,6" />
        <Setter Property="Template">
          <Setter.Value>
            <ControlTemplate TargetType="controls:LibrarySearchQueryBox">
              <Border Background="{TemplateBinding Background}"
                      BorderBrush="{TemplateBinding BorderBrush}"
                      BorderThickness="{TemplateBinding BorderThickness}"
                      CornerRadius="18"
                      Padding="{TemplateBinding Padding}">
                <ScrollViewer x:Name="PART_ContentHost"
                              Focusable="false"
                              HorizontalScrollBarVisibility="{TemplateBinding HorizontalScrollBarVisibility}"
                              VerticalScrollBarVisibility="{TemplateBinding VerticalScrollBarVisibility}" />
              </Border>
            </ControlTemplate>
          </Setter.Value>
        </Setter>
      </Style>
    </ResourceDictionary>

  </UserControl.Resources>
  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
    </Grid.RowDefinitions>
    <Grid.ColumnDefinitions>
      <ColumnDefinition Width="{Binding DataContext.Filters.LeftPanelWidth, ElementName=LibraryViewControl, Mode=TwoWay}" MinWidth="0"/>
      <ColumnDefinition Width="Auto"/>
      <ColumnDefinition Width="*"/>
      <ColumnDefinition Width="Auto"/>
      <ColumnDefinition Width="{Binding DataContext.Filters.RightPanelWidth, ElementName=LibraryViewControl, Mode=TwoWay}" MinWidth="0"/>
    </Grid.ColumnDefinitions>

    <!-- Search header -->
    <Border Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="5" Background="#FFF7F7F7" BorderBrush="#FFE0E0E0" BorderThickness="0,0,0,1">
      <Grid DataContext="{Binding Filters}" Margin="12">
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto"/>
          <RowDefinition Height="Auto"/>
          <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*"/>
          <ColumnDefinition Width="Auto"/>
        </Grid.ColumnDefinitions>

        <StackPanel Grid.Row="0" Grid.Column="0">
          <TextBlock Text="Library search" FontWeight="SemiBold"/>
          <controls:LibrarySearchQueryBox Margin="0,6,0,0"
                                          Text="{Binding UnifiedQuery}"
                                          ToolTip="{Binding KeywordTooltip}"
                                          ToolTipService.ShowDuration="60000"/>
          <TextBlock Text="Examples: title:heart AND tags:aortic, author:nicolas, NOT internal:true"
                     FontSize="11"
                     Foreground="DimGray"
                     Margin="0,4,0,0"/>
        </StackPanel>

        <StackPanel Grid.Row="0" Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Top">
          <Button Margin="0,0,8,0"
                  Padding="10,4"
                  Command="{Binding ToggleLeftPanelCommand}"
                  ToolTip="Show or hide the saved searches panel">
            <Button.Style>
              <Style TargetType="Button">
                <Setter Property="Content" Value="Hide saved" />
                <Style.Triggers>
                  <DataTrigger Binding="{Binding IsLeftPanelCollapsed}" Value="True">
                    <Setter Property="Content" Value="Show saved" />
                  </DataTrigger>
                </Style.Triggers>
              </Style>
            </Button.Style>
          </Button>
          <Button Padding="10,4"
                  Command="{Binding ToggleRightPanelCommand}"
                  ToolTip="Show or hide the entry details panel">
            <Button.Style>
              <Style TargetType="Button">
                <Setter Property="Content" Value="Hide details" />
                <Style.Triggers>
                  <DataTrigger Binding="{Binding IsRightPanelCollapsed}" Value="True">
                    <Setter Property="Content" Value="Show details" />
                  </DataTrigger>
                </Style.Triggers>
              </Style>
            </Button.Style>
          </Button>
        </StackPanel>

        <StackPanel Grid.Row="1" Grid.Column="0" Orientation="Horizontal" Margin="0,8,0,0">
          <Button Content="Search"
                  Margin="0,0,8,0"
                  Command="{Binding DataContext.SearchCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
          <Button Content="Clear"
                  Margin="0,0,8,0"
                  Command="{Binding ClearCommand}"/>
          <Button Content="Save search"
                  Margin="0,0,8,0"
                  Command="{Binding SavePresetCommand}"/>
          <Button Content="Manage saved"
                  Margin="0,0,8,0"
                  Command="{Binding ManagePresetsCommand}"/>
          <Button Content="Load saved"
                  Command="{Binding LoadPresetCommand}"/>
        </StackPanel>

        <StackPanel Grid.Row="1" Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" Margin="8,8,0,0">
          <CheckBox Content="Full-text search" IsChecked="{Binding UseFullTextSearch}"/>
        </StackPanel>

        <StackPanel Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2" Margin="0,8,0,0"
                    Visibility="{Binding UseFullTextSearch, Converter={StaticResource BoolToVisibilityConverter}}">
          <TextBox Text="{Binding FullTextQuery, UpdateSourceTrigger=PropertyChanged}"/>
          <StackPanel Orientation="Horizontal" Margin="0,6,0,0">
            <TextBlock Text="Search within:" VerticalAlignment="Center" Margin="0,0,8,0"/>
            <CheckBox Content="Title" Margin="0,0,8,0" IsChecked="{Binding FullTextInTitle}"/>
            <CheckBox Content="Abstract" Margin="0,0,8,0" IsChecked="{Binding FullTextInAbstract}"/>
            <CheckBox Content="Content" IsChecked="{Binding FullTextInContent}"/>
          </StackPanel>
        </StackPanel>
      </Grid>
    </Border>

    <!-- Navigation tree -->
    <Border Grid.Row="1" Grid.Column="0" BorderBrush="#FFE0E0E0" BorderThickness="0,1,0,0">
      <ScrollViewer VerticalScrollBarVisibility="Auto" DataContext="{Binding Filters}">
        <StackPanel Margin="12">
          <TextBlock Text="Saved searches" FontWeight="SemiBold" Margin="0,0,0,8"/>
          <TreeView ItemsSource="{Binding NavigationRoots}" SelectedItemChanged="OnNavigationSelected">
            <TreeView.ItemTemplate>
              <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                <StackPanel>
                  <TextBlock Text="{Binding Name}">
                    <TextBlock.Style>
                      <Style TargetType="TextBlock">
                        <Setter Property="FontWeight" Value="Normal"/>
                        <Style.Triggers>
                          <DataTrigger Binding="{Binding Kind}" Value="{x:Static viewModels:LibraryNavigationNodeKind.Category}">
                            <Setter Property="FontWeight" Value="SemiBold"/>
                          </DataTrigger>
                        </Style.Triggers>
                      </Style>
                    </TextBlock.Style>
                  </TextBlock>
                  <TextBlock Text="{Binding Subtitle}" FontSize="11" Foreground="DimGray">
                    <TextBlock.Style>
                      <Style TargetType="TextBlock">
                        <Setter Property="Visibility" Value="Visible"/>
                        <Style.Triggers>
                          <DataTrigger Binding="{Binding Subtitle}" Value="{x:Null}">
                            <Setter Property="Visibility" Value="Collapsed"/>
                          </DataTrigger>
                          <DataTrigger Binding="{Binding Subtitle}" Value="">
                            <Setter Property="Visibility" Value="Collapsed"/>
                          </DataTrigger>
                        </Style.Triggers>
                      </Style>
                    </TextBlock.Style>
                  </TextBlock>
                </StackPanel>
              </HierarchicalDataTemplate>
            </TreeView.ItemTemplate>
          </TreeView>
        </StackPanel>
      </ScrollViewer>
    </Border>


    <Button Grid.Row="1"
            Grid.Column="1"
            Command="{Binding DataContext.Filters.ToggleLeftPanelCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
            HorizontalAlignment="Left"
            VerticalAlignment="Center"
            Padding="0"
            Width="20"
            Height="48"
            Margin="0,0,5,0"
            Background="#FFF4F4F4"
            BorderBrush="#FFBEBEBE"
            BorderThickness="1">
      <Button.Style>
        <Style TargetType="Button">
          <Setter Property="Content" Value="«" />
          <Setter Property="ToolTip" Value="Hide saved searches panel" />
          <Setter Property="FontFamily" Value="Segoe UI Symbol" />
          <Setter Property="FontSize" Value="13" />
          <Setter Property="FontWeight" Value="Bold" />
          <Setter Property="Foreground" Value="DimGray" />
          <Style.Triggers>
            <DataTrigger Binding="{Binding DataContext.Filters.IsLeftPanelCollapsed, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="True">
              <Setter Property="Content" Value="»" />
              <Setter Property="ToolTip" Value="Show saved searches panel" />
            </DataTrigger>
          </Style.Triggers>
        </Style>
      </Button.Style>
    </Button>
    <GridSplitter Grid.Row="1"
                  Grid.Column="1"
                  HorizontalAlignment="Right"
                  VerticalAlignment="Stretch"
                  Background="#FFE0E0E0"
                  ShowsPreview="True"
                  Width="5">
      <GridSplitter.Style>
        <Style TargetType="GridSplitter">
          <Setter Property="Visibility" Value="Visible" />
          <Style.Triggers>
            <DataTrigger Binding="{Binding DataContext.Filters.IsLeftPanelCollapsed, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="True">
              <Setter Property="Visibility" Value="Collapsed" />
            </DataTrigger>
          </Style.Triggers>
        </Style>
      </GridSplitter.Style>
    </GridSplitter>


    <!-- Results -->
    <Grid Grid.Row="1" Grid.Column="2" DataContext="{Binding Results}">
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto"/>
        <RowDefinition Height="*"/>
        <RowDefinition Height="Auto"/>
      </Grid.RowDefinitions>

      <StackPanel Orientation="Horizontal" Margin="12">
        <TextBlock Text="Results" FontWeight="Bold"/>
        <TextBlock Text="(Full-text ranking)"
                   Margin="8,0,0,0"
                   Foreground="DimGray"
                   Visibility="{Binding ResultsAreFullText, Converter={StaticResource BoolToVisibilityConverter}}"/>
        <Menu Margin="12,0,0,0"
              VerticalAlignment="Center"
              DataContext="{Binding DataContext, RelativeSource={RelativeSource AncestorType=UserControl}}">
          <MenuItem Header="Columns"
                    ItemsSource="{Binding ColumnOptions}">
            <MenuItem.ItemContainerStyle>
              <Style TargetType="MenuItem">
                <Setter Property="Header" Value="{Binding DisplayName}" />
                <Setter Property="IsCheckable" Value="True" />
                <Setter Property="IsChecked" Value="{Binding IsVisible, Mode=TwoWay}" />
              </Style>
            </MenuItem.ItemContainerStyle>
          </MenuItem>
        </Menu>
      </StackPanel>

      <DataGrid Grid.Row="1"
                ItemsSource="{Binding Items}"
                SelectedItem="{Binding Selected}"
                Margin="12"
                IsReadOnly="True"
                AllowDrop="True"
                CanUserReorderColumns="True"
                CanUserResizeColumns="True"
                SelectionMode="Extended"
                SelectionUnit="FullRow">
        <DataGrid.Resources>
          <Style TargetType="DataGridRow">
            <Setter Property="Tag" Value="{Binding DataContext, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
            <Setter Property="ContextMenu">
              <Setter.Value>
                <ContextMenu>
                  <MenuItem Header="Open"
                            Command="{Binding PlacementTarget.Tag.OpenEntryCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                            CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}" />
                  <MenuItem Header="Open containing folder"
                            Command="{Binding PlacementTarget.Tag.OpenContainingFolderCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                            CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}" />
                  <MenuItem Header="Copy citation / DOI"
                            Command="{Binding PlacementTarget.Tag.CopyMetadataCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                            CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}" />
                  <MenuItem Header="Copy workspace path"
                            Command="{Binding PlacementTarget.Tag.CopyWorkspacePathCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                            CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}" />
                  <Separator />
                  <MenuItem Header="Edit entry"
                            Command="{Binding PlacementTarget.Tag.EditEntryCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                            CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}" />
                </ContextMenu>
              </Setter.Value>
            </Setter>
          </Style>
        </DataGrid.Resources>
        <i:Interaction.Behaviors>
          <behaviors:FileDropBehavior UseDataGridRowContext="True"
                                      PreviewDragOverCommand="{Binding PreviewDropCommand}"
                                      DropCommand="{Binding DropCommand}" />
          <behaviors:DataGridColumnVisibilityBehavior VisibilityMap="{Binding DataContext.ColumnVisibility, RelativeSource={RelativeSource AncestorType=UserControl}}" />
        </i:Interaction.Behaviors>
        <i:Interaction.Triggers>
          <i:EventTrigger EventName="SelectionChanged">
            <i:InvokeCommandAction Command="{Binding HandleSelectionChangedCommand}"
                                   CommandParameter="{Binding SelectedItems, RelativeSource={RelativeSource AncestorType=DataGrid}}" />
          </i:EventTrigger>
        </i:Interaction.Triggers>
        <DataGrid.Columns>
          <StaticResource ResourceKey="LibraryResultsColumn.AttachmentIndicator" />
          <StaticResource ResourceKey="LibraryResultsColumn.Title" />
          <StaticResource ResourceKey="LibraryResultsColumn.Score" />
          <StaticResource ResourceKey="LibraryResultsColumn.Source" />
          <StaticResource ResourceKey="LibraryResultsColumn.Type" />
          <StaticResource ResourceKey="LibraryResultsColumn.Year" />
          <StaticResource ResourceKey="LibraryResultsColumn.AddedOn" />
          <StaticResource ResourceKey="LibraryResultsColumn.AddedBy" />
          <StaticResource ResourceKey="LibraryResultsColumn.InternalId" />
          <StaticResource ResourceKey="LibraryResultsColumn.Doi" />
          <StaticResource ResourceKey="LibraryResultsColumn.Pmid" />
          <StaticResource ResourceKey="LibraryResultsColumn.Nct" />
          <StaticResource ResourceKey="LibraryResultsColumn.Authors" />
          <StaticResource ResourceKey="LibraryResultsColumn.Tags" />
          <StaticResource ResourceKey="LibraryResultsColumn.IsInternal" />
          <StaticResource ResourceKey="LibraryResultsColumn.Snippet" />
        </DataGrid.Columns>
      </DataGrid>

      <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="12">
        <Button Content="Open"
                Command="{Binding DataContext.OpenEntryCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
      </StackPanel>
    </Grid>


    <GridSplitter Grid.Row="1"
                  Grid.Column="3"
                  HorizontalAlignment="Left"
                  VerticalAlignment="Stretch"
                  Background="#FFE0E0E0"
                  ShowsPreview="True"
                  Width="5">
      <GridSplitter.Style>
        <Style TargetType="GridSplitter">
          <Setter Property="Visibility" Value="Visible" />
          <Style.Triggers>
            <DataTrigger Binding="{Binding DataContext.Filters.IsRightPanelCollapsed, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="True">
              <Setter Property="Visibility" Value="Collapsed" />
            </DataTrigger>
          </Style.Triggers>
        </Style>
      </GridSplitter.Style>
    </GridSplitter>
    <Button Grid.Row="1"
            Grid.Column="3"
            Command="{Binding DataContext.Filters.ToggleRightPanelCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
            HorizontalAlignment="Right"
            VerticalAlignment="Center"
            Padding="0"
            Width="20"
            Height="48"
            Margin="5,0,0,0"
            Background="#FFF4F4F4"
            BorderBrush="#FFBEBEBE"
            BorderThickness="1">
      <Button.Style>
        <Style TargetType="Button">
          <Setter Property="Content" Value="»" />
          <Setter Property="ToolTip" Value="Hide entry details panel" />
          <Setter Property="FontFamily" Value="Segoe UI Symbol" />
          <Setter Property="FontSize" Value="13" />
          <Setter Property="FontWeight" Value="Bold" />
          <Setter Property="Foreground" Value="DimGray" />
          <Style.Triggers>
            <DataTrigger Binding="{Binding DataContext.Filters.IsRightPanelCollapsed, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="True">
              <Setter Property="Content" Value="«" />
              <Setter Property="ToolTip" Value="Show entry details panel" />
            </DataTrigger>
          </Style.Triggers>
        </Style>
      </Button.Style>
    </Button>


    <Border Grid.Row="1" Grid.Column="4" BorderBrush="#FFE0E0E0" BorderThickness="1,0,0,0" Background="#FFFDFDFD">
      <ScrollViewer VerticalScrollBarVisibility="Auto"
                    AllowDrop="True"
                    DataContext="{Binding Results}">
        <i:Interaction.Behaviors>
          <behaviors:FileDropBehavior PreviewDragOverCommand="{Binding PreviewDropCommand}"
                                      DropCommand="{Binding DropCommand}" />
        </i:Interaction.Behaviors>
        <Grid>

          <ContentPresenter x:Name="EntryDetailPresenter"
                            Content="{Binding Selected}"
                            ContentTemplate="{StaticResource LibraryEntryDetailTemplate}"
                            Margin="12">

            <ContentPresenter.Style>
              <Style TargetType="ContentPresenter">
                <Setter Property="Visibility" Value="Visible"/>
                <Style.Triggers>

                  <Trigger Property="Content" Value="{x:Null}">
                    <Setter Property="Visibility" Value="Collapsed"/>
                  </Trigger>

                </Style.Triggers>
              </Style>
            </ContentPresenter.Style>
          </ContentPresenter>

          <TextBlock Text="Select an entry to view details."
                     Margin="12"
                     FontStyle="Italic"
                     Foreground="Gray"
                     TextWrapping="Wrap"
                     VerticalAlignment="Center"
                     HorizontalAlignment="Center">
            <TextBlock.Style>
              <Style TargetType="TextBlock">
                <Setter Property="Visibility" Value="Collapsed"/>
                <Style.Triggers>

                  <DataTrigger Binding="{Binding Content, ElementName=EntryDetailPresenter}" Value="{x:Null}">

                    <Setter Property="Visibility" Value="Visible"/>
                  </DataTrigger>
                </Style.Triggers>
              </Style>
            </TextBlock.Style>
          </TextBlock>
        </Grid>
      </ScrollViewer>
    </Border>
  </Grid>
</UserControl>
