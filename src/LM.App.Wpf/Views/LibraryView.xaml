<UserControl x:Class="LM.App.Wpf.Views.LibraryView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
             xmlns:controls="clr-namespace:LM.App.Wpf.Views.Library.Controls"
             xmlns:behaviors="clr-namespace:LM.App.Wpf.Views.Behaviors"
             xmlns:collections="clr-namespace:LM.App.Wpf.ViewModels.Library.Collections"
             xmlns:lit="clr-namespace:LM.App.Wpf.ViewModels.Library.LitSearch"
             xmlns:saved="clr-namespace:LM.App.Wpf.ViewModels.Library.SavedSearches"

            x:Name="LibraryViewControl"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="1000">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="260" MinWidth="200"/>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*" MinWidth="300"/>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="300" MinWidth="0" Name="RightColumn"/>
        </Grid.ColumnDefinitions>

        <!-- Compact Search header -->
        <Border Grid.Row="0"
                Grid.Column="0"
                Grid.ColumnSpan="5"
                Background="#FAFAFA"
                BorderBrush="#E5E7EB"
                BorderThickness="0,0,0,1"
                Padding="8,6">
            <Grid DataContext="{Binding Filters}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <controls:LibrarySearchQueryBox x:Name="UnifiedQueryBox"
                                                Grid.Column="0"
                                                Margin="0,0,12,0"
                                                MaxWidth="600"
                                                VerticalAlignment="Center"
                                                Text="{Binding UnifiedQuery, UpdateSourceTrigger=PropertyChanged}">
                    <controls:LibrarySearchQueryBox.InputBindings>
                        <KeyBinding Key="Enter"
                                    Command="{Binding DataContext.SearchCommand, ElementName=LibraryViewControl}"/>
                    </controls:LibrarySearchQueryBox.InputBindings>
                </controls:LibrarySearchQueryBox>
                <StackPanel Grid.Column="1"
                            Orientation="Horizontal"
                            VerticalAlignment="Center">
                    <!-- Save Search Button -->
                    <Button Content="💾 Save Search"
                            Padding="10,4"
                            Margin="0,0,8,0"
                            Command="{Binding SavePresetCommand}"
                            ToolTip="Save current search filters"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Left Panel - Collections/Tags/Searches/LitSearch Organizer -->
        <Border Grid.Row="1"
                Grid.Column="0"
                Background="#F8F9FA"
                BorderBrush="#E5E7EB"
                BorderThickness="0,1,0,0"
                Name="LeftPanelBorder">
            <ScrollViewer VerticalScrollBarVisibility="Auto"
                          HorizontalScrollBarVisibility="Disabled"
                          DataContext="{Binding Filters}">
                <StackPanel Margin="0">

                    <!-- Collections -->
                    <Border Background="White"
                            BorderBrush="#E5E7EB"
                            BorderThickness="0"
                            Margin="0,0,0,8">
                        <StackPanel>
                            <Border Background="#F3F4F6"
                                    BorderBrush="#E5E7EB"
                                    BorderThickness="0,0,0,1"
                                    Padding="8,6">
                                <DockPanel>
                                    <ToggleButton x:Name="CollectionsToggle"
                                                  IsChecked="True"
                                                  Width="16"
                                                  Height="16"
                                                  DockPanel.Dock="Left"
                                                  VerticalAlignment="Center">
                                        <ToggleButton.Template>
                                            <ControlTemplate TargetType="ToggleButton">
                                                <Border Background="Transparent">
                                                    <TextBlock FontFamily="Segoe MDL2 Assets"
                                                               FontSize="12"
                                                               Text="&#xE70D;"
                                                               VerticalAlignment="Center"
                                                               HorizontalAlignment="Center">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Setter Property="Foreground" Value="#6B7280"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsChecked, RelativeSource={RelativeSource TemplatedParent}}" Value="False">
                                                                        <Setter Property="Text" Value="&#xE76C;"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                </Border>
                                            </ControlTemplate>
                                        </ToggleButton.Template>
                                    </ToggleButton>
                                    <TextBlock Text="COLLECTIONS"
                                               FontSize="11"
                                               FontWeight="SemiBold"
                                               Foreground="#6B7280"
                                               Margin="4,0,0,0"/>
                                </DockPanel>
                            </Border>
                            <TreeView Margin="0"
                                      x:Name="CollectionsTree"
                                      DataContext="{Binding DataContext.Collections, ElementName=LibraryViewControl}"
                                      ItemsSource="{Binding Root.Children}"
                                      Background="Transparent"
                                      BorderThickness="0"
                                      HorizontalContentAlignment="Stretch"
                                      Visibility="{Binding IsChecked, ElementName=CollectionsToggle, Converter={StaticResource BoolToVisibilityConverter}}"
                                      SelectedItemChanged="OnCollectionSelected">
                                <i:Interaction.Behaviors>
                                    <behaviors:CollectionTreeDragDropBehavior />
                                </i:Interaction.Behaviors>
                                <TreeView.Resources>
                                    <HierarchicalDataTemplate DataType="{x:Type collections:LibraryCollectionFolderViewModel}"
                                                              ItemsSource="{Binding Children}">
                                        <DockPanel>
                                            <TextBlock DockPanel.Dock="Right"
                                                       Text="{Binding EntryCount}"
                                                       Margin="6,2,4,2"
                                                       Foreground="#6B7280"
                                                       FontSize="11"
                                                       HorizontalAlignment="Right"/>
                                            <TextBlock Text="{Binding Name}"
                                                       Margin="4,2"
                                                       FontWeight="SemiBold"
                                                       TextTrimming="CharacterEllipsis"/>
                                        </DockPanel>
                                        <HierarchicalDataTemplate.ItemContainerStyle>
                                            <Style TargetType="TreeViewItem">
                                                <Setter Property="IsExpanded" Value="True" />
                                                <Setter Property="ContextMenu">
                                                    <Setter.Value>
                                                        <ContextMenu DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
                                                            <MenuItem Header="New Folder"
                                                                      Command="{Binding Tree.CreateFolderCommand}"
                                                                      CommandParameter="{Binding}" />
                                                            <MenuItem Header="Rename"
                                                                      Command="{Binding Tree.RenameFolderCommand}"
                                                                      CommandParameter="{Binding}" />
                                                            <Separator/>
                                                            <MenuItem Header="Add Selection"
                                                                      Command="{Binding Tree.AddSelectionToFolderCommand}"
                                                                      CommandParameter="{Binding}" />
                                                            <MenuItem Header="Remove Selection"
                                                                      Command="{Binding Tree.RemoveSelectionFromFolderCommand}"
                                                                      CommandParameter="{Binding}" />
                                                            <Separator/>
                                                            <MenuItem Header="Delete Folder"
                                                                      Command="{Binding Tree.DeleteFolderCommand}"
                                                                      CommandParameter="{Binding}" />
                                                        </ContextMenu>
                                                    </Setter.Value>
                                                </Setter>
                                            </Style>
                                        </HierarchicalDataTemplate.ItemContainerStyle>
                                    </HierarchicalDataTemplate>
                                </TreeView.Resources>
                            </TreeView>
                        </StackPanel>
                    </Border>

                    <!-- LitSearch Organizer -->
                    <Border Background="White"
                            BorderBrush="#E5E7EB"
                            BorderThickness="0"
                            Margin="0,0,0,8">
                        <StackPanel>
                            <Border Background="#F3F4F6"
                                    BorderBrush="#E5E7EB"
                                    BorderThickness="0,0,0,1"
                                    Padding="8,6">
                                <DockPanel>
                                    <ToggleButton x:Name="LitSearchToggle"
                                                  IsChecked="True"
                                                  Width="16"
                                                  Height="16"
                                                  DockPanel.Dock="Left"
                                                  VerticalAlignment="Center">
                                        <ToggleButton.Template>
                                            <ControlTemplate TargetType="ToggleButton">
                                                <Border Background="Transparent">
                                                    <TextBlock FontFamily="Segoe MDL2 Assets"
                                                               FontSize="12"
                                                               Text="&#xE70D;"
                                                               VerticalAlignment="Center"
                                                               HorizontalAlignment="Center">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Setter Property="Foreground" Value="#6B7280"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsChecked, RelativeSource={RelativeSource TemplatedParent}}" Value="False">
                                                                        <Setter Property="Text" Value="&#xE76C;"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                </Border>
                                            </ControlTemplate>
                                        </ToggleButton.Template>
                                    </ToggleButton>
                                    <TextBlock Text="LITSEARCH ORGANIZER"
                                               FontSize="11"
                                               FontWeight="SemiBold"
                                               Foreground="#6B7280"
                                               Margin="4,0,0,0"/>
                                </DockPanel>
                            </Border>
                            <TreeView Margin="0"
                                      DataContext="{Binding DataContext.LitSearchOrganizer, ElementName=LibraryViewControl}"
                                      ItemsSource="{Binding Root.Children}"
                                      Background="Transparent"
                                      BorderThickness="0"
                                      HorizontalContentAlignment="Stretch"
                                      Visibility="{Binding IsChecked, ElementName=LitSearchToggle, Converter={StaticResource BoolToVisibilityConverter}}"
                                      SelectedItemChanged="OnLitSearchSelected"
                                      PreviewMouseDoubleClick="OnLitSearchTreeViewDoubleClick">
                                <i:Interaction.Behaviors>
                                    <behaviors:LitSearchTreeDragDropBehavior />
                                </i:Interaction.Behaviors>
                                <TreeView.Resources>
                                    <HierarchicalDataTemplate DataType="{x:Type lit:LitSearchFolderViewModel}"
                                                              ItemsSource="{Binding Children}">
                                        <TextBlock Text="{Binding Name}" Margin="4,2"/>
                                        <HierarchicalDataTemplate.ItemContainerStyle>
                                            <Style TargetType="TreeViewItem">
                                                <Setter Property="IsExpanded" Value="True" />
                                                <Setter Property="ContextMenu">
                                                    <Setter.Value>
                                                        <ContextMenu DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
                                                            <MenuItem Header="New Folder"
                                                                      Command="{Binding Tree.CreateFolderCommand}"
                                                                      CommandParameter="{Binding}" />
                                                            <MenuItem Header="Rename"
                                                                      Command="{Binding Tree.RenameFolderCommand}"
                                                                      CommandParameter="{Binding}" />
                                                            <Separator/>
                                                            <MenuItem Header="Delete Folder"
                                                                      Command="{Binding Tree.DeleteFolderCommand}"
                                                                      CommandParameter="{Binding}"
                                                                      IsEnabled="{Binding CanDelete}" />
                                                        </ContextMenu>
                                                    </Setter.Value>
                                                </Setter>
                                            </Style>
                                        </HierarchicalDataTemplate.ItemContainerStyle>
                                    </HierarchicalDataTemplate>
                                    <HierarchicalDataTemplate DataType="{x:Type lit:LitSearchEntryViewModel}"
                                                              ItemsSource="{Binding Runs}">
                                        <StackPanel Margin="4,2">
                                            <TextBlock Text="{Binding Title}" FontWeight="SemiBold" TextTrimming="CharacterEllipsis"/>
                                            <TextBlock Text="{Binding Query}"
                                                       FontSize="11"
                                                       Foreground="#6B7280"
                                                       TextTrimming="CharacterEllipsis"/>
                                        </StackPanel>
                                    </HierarchicalDataTemplate>
                                    <DataTemplate DataType="{x:Type lit:LitSearchRunViewModel}">
                                        <TextBlock Text="{Binding Label}" Margin="4,2" TextTrimming="CharacterEllipsis"/>
                                    </DataTemplate>
                                </TreeView.Resources>
                            </TreeView>
                        </StackPanel>
                    </Border>

                    <!-- Saved Searches -->
                    <Border Background="White"
                            BorderBrush="#E5E7EB"
                            BorderThickness="0"
                            Margin="0,0,0,8">
                        <StackPanel>
                            <Border Background="#F3F4F6"
                                    BorderBrush="#E5E7EB"
                                    BorderThickness="0,0,0,1"
                                    Padding="8,6">
                                <DockPanel>
                                    <ToggleButton x:Name="SavedSearchToggle"
                                                  IsChecked="True"
                                                  Width="16"
                                                  Height="16"
                                                  DockPanel.Dock="Left"
                                                  VerticalAlignment="Center">
                                        <ToggleButton.Template>
                                            <ControlTemplate TargetType="ToggleButton">
                                                <Border Background="Transparent">
                                                    <TextBlock FontFamily="Segoe MDL2 Assets"
                                                               FontSize="12"
                                                               Text="&#xE70D;"
                                                               VerticalAlignment="Center"
                                                               HorizontalAlignment="Center">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Setter Property="Foreground" Value="#6B7280"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsChecked, RelativeSource={RelativeSource TemplatedParent}}" Value="False">
                                                                        <Setter Property="Text" Value="&#xE76C;"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                </Border>
                                            </ControlTemplate>
                                        </ToggleButton.Template>
                                    </ToggleButton>
                                    <TextBlock Text="SAVED SEARCHES"
                                               FontSize="11"
                                               FontWeight="SemiBold"
                                               Foreground="#6B7280"
                                               Margin="4,0,0,0"/>
                                </DockPanel>
                            </Border>
                            <TreeView x:Name="SavedSearchTree"
                                      Margin="0"
                                      DataContext="{Binding SavedSearches}"
                                      ItemsSource="{Binding Root.Children}"
                                      Background="Transparent"
                                      BorderThickness="0"
                                      HorizontalContentAlignment="Stretch"
                                      Visibility="{Binding IsChecked, ElementName=SavedSearchToggle, Converter={StaticResource BoolToVisibilityConverter}}"
                                      SelectedItemChanged="OnSavedSearchSelected">
                                <TreeView.Resources>
                                    <HierarchicalDataTemplate DataType="{x:Type saved:SavedSearchFolderViewModel}"
                                                              ItemsSource="{Binding Children}">
                                        <TextBlock Text="{Binding Name}" Margin="4,2"/>
                                        <HierarchicalDataTemplate.ItemContainerStyle>
                                            <Style TargetType="TreeViewItem">
                                                <Setter Property="IsExpanded" Value="True" />
                                                <Setter Property="ContextMenu">
                                                    <Setter.Value>
                                                        <ContextMenu DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
                                                            <MenuItem Header="New Folder"
                                                                      Command="{Binding Tree.CreateFolderCommand}"
                                                                      CommandParameter="{Binding}" />
                                                            <MenuItem Header="Rename"
                                                                      Command="{Binding Tree.RenameFolderCommand}"
                                                                      CommandParameter="{Binding}" />
                                                            <Separator/>
                                                            <MenuItem Header="Delete Folder"
                                                                      Command="{Binding Tree.DeleteFolderCommand}"
                                                                      CommandParameter="{Binding}" />
                                                        </ContextMenu>
                                                    </Setter.Value>
                                                </Setter>
                                            </Style>
                                        </HierarchicalDataTemplate.ItemContainerStyle>
                                    </HierarchicalDataTemplate>
                                    <DataTemplate DataType="{x:Type saved:SavedSearchPresetViewModel}">
                                        <TextBlock Text="{Binding Name}" Margin="4,2">
                                            <TextBlock.ContextMenu>
                                                <ContextMenu DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
                                                    <MenuItem Header="Load"
                                                              Command="{Binding Tree.LoadPresetCommand}"
                                                              CommandParameter="{Binding}" />
                                                    <Separator/>
                                                    <MenuItem Header="Delete"
                                                              Command="{Binding Tree.DeletePresetCommand}"
                                                              CommandParameter="{Binding}" />
                                                </ContextMenu>
                                            </TextBlock.ContextMenu>
                                        </TextBlock>
                                    </DataTemplate>
                                </TreeView.Resources>
                            </TreeView>
                        </StackPanel>
                    </Border>

                    <!-- Tags -->
                    <Border Background="White"
                            BorderBrush="#E5E7EB"
                            BorderThickness="0"
                            Margin="0,0,0,8">
                        <StackPanel>
                            <Border Background="#F3F4F6"
                                    BorderBrush="#E5E7EB"
                                    BorderThickness="0,0,0,1"
                                    Padding="8,6">
                                <DockPanel>
                                    <ToggleButton x:Name="TagsToggle"
                                                  IsChecked="True"
                                                  Width="16"
                                                  Height="16"
                                                  DockPanel.Dock="Left"
                                                  VerticalAlignment="Center">
                                        <ToggleButton.Template>
                                            <ControlTemplate TargetType="ToggleButton">
                                                <Border Background="Transparent">
                                                    <TextBlock FontFamily="Segoe MDL2 Assets"
                                                               FontSize="12"
                                                               Text="&#xE70D;"
                                                               VerticalAlignment="Center"
                                                               HorizontalAlignment="Center">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Setter Property="Foreground" Value="#6B7280"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsChecked, RelativeSource={RelativeSource TemplatedParent}}" Value="False">
                                                                        <Setter Property="Text" Value="&#xE76C;"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                </Border>
                                            </ControlTemplate>
                                        </ToggleButton.Template>
                                    </ToggleButton>
                                    <TextBlock Text="TAGS"
                                               FontSize="11"
                                               FontWeight="SemiBold"
                                               Foreground="#6B7280"
                                               Margin="4,0,0,0"/>
                                </DockPanel>
                            </Border>
                            <ItemsControl ItemsSource="{Binding DataContext.AllTags, ElementName=LibraryViewControl}"
                                          Margin="0"
                                          Background="Transparent"
                                          Visibility="{Binding IsChecked, ElementName=TagsToggle, Converter={StaticResource BoolToVisibilityConverter}}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding}"
                                                   Margin="8,4"
                                                   Cursor="Hand"
                                                   MouseLeftButtonUp="OnTagClick">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Foreground" Value="#374151"/>
                                                    <Style.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="Foreground" Value="#2563EB"/>
                                                            <Setter Property="TextDecorations" Value="Underline"/>
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </Border>

                </StackPanel>
            </ScrollViewer>
        </Border>

        <!-- Splitter -->
        <GridSplitter Grid.Row="1"
                      Grid.Column="1"
                      Width="1"
                      Background="#E5E7EB"
                      HorizontalAlignment="Center"
                      VerticalAlignment="Stretch"/>


<!-- Center - Results List (Compact Zotero-style) -->
                <DataGrid Grid.Row="1"
                  Grid.Column="2"
                  x:Name="ResultsList"
                  ItemsSource="{Binding Results.ItemsView}"
                  SelectedItem="{Binding Results.Selected}"
                  AutoGenerateColumns="False"
                  CanUserAddRows="False"
                  CanUserDeleteRows="False"
                  CanUserReorderColumns="True"
                  CanUserResizeColumns="True"
                  CanUserSortColumns="True"
                  GridLinesVisibility="Horizontal"
                  HorizontalGridLinesBrush="#E5E7EB"
                  BorderThickness="0"
                  Background="White"
                  RowHeight="24"
                  HeadersVisibility="Column">
                    <i:Interaction.Behaviors>
                        <behaviors:DataGridColumnVisibilityBehavior VisibilityMap="{Binding ColumnVisibility}" />
                    </i:Interaction.Behaviors>
                    <i:Interaction.Triggers>
                        <i:EventTrigger EventName="Sorting">
                            <i:CallMethodAction TargetObject="{Binding Results}" MethodName="HandleGridSorting" />
                        </i:EventTrigger>
                        <i:EventTrigger EventName="Loaded">
                            <i:CallMethodAction TargetObject="{Binding Results}" MethodName="HandleGridLoaded" />
                        </i:EventTrigger>
                    </i:Interaction.Triggers>
                    <DataGrid.ContextMenu>
                        <ContextMenu DataContext="{Binding DataContext, ElementName=LibraryViewControl}">
                            <MenuItem Header="Add to collection..."
                                      ItemsSource="{Binding Collections.Root.Children}">
                                <MenuItem.ItemContainerStyle>
                                    <Style TargetType="MenuItem">
                                        <Setter Property="Command"
                                                Value="{Binding DataContext.Collections.AddSelectionToFolderCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" />
                                        <Setter Property="CommandParameter" Value="{Binding}" />
                                    </Style>
                                </MenuItem.ItemContainerStyle>
                                <MenuItem.ItemTemplate>
                                    <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                                        <TextBlock Text="{Binding Name}" />
                                    </HierarchicalDataTemplate>
                                </MenuItem.ItemTemplate>
                            </MenuItem>
                            <MenuItem Header="Remove from collection..."
                                      ItemsSource="{Binding Collections.Root.Children}">
                                <MenuItem.ItemContainerStyle>
                                    <Style TargetType="MenuItem">
                                        <Setter Property="Command"
                                                Value="{Binding DataContext.Collections.RemoveSelectionFromFolderCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" />
                                        <Setter Property="CommandParameter" Value="{Binding}" />
                                    </Style>
                                </MenuItem.ItemContainerStyle>
                                <MenuItem.ItemTemplate>
                                    <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                                        <TextBlock Text="{Binding Name}" />
                                    </HierarchicalDataTemplate>
                                </MenuItem.ItemTemplate>
                            </MenuItem>
                            <Separator />
                            <MenuItem Header="Open in PDF viewer"
                                      Command="{Binding OpenPdfAnnotationsCommand}"
                                      CommandParameter="{Binding PlacementTarget.SelectedItem, RelativeSource={RelativeSource AncestorType=ContextMenu}}" />
                            <MenuItem Header="Open externally"
                                      Command="{Binding OpenEntryCommand}"
                                      CommandParameter="{Binding PlacementTarget.SelectedItem, RelativeSource={RelativeSource AncestorType=ContextMenu}}" />
                            <MenuItem Header="Edit entry"
                                      Command="{Binding EditEntryCommand}"
                                      CommandParameter="{Binding PlacementTarget.SelectedItem, RelativeSource={RelativeSource AncestorType=ContextMenu}}" />
                            <MenuItem Header="Copy citation"
                                      Command="{Binding CopyMetadataCommand}"
                                      CommandParameter="{Binding PlacementTarget.SelectedItem, RelativeSource={RelativeSource AncestorType=ContextMenu}}" />
                            <MenuItem Command="{Binding ToggleBlacklistCommand}"
                                      CommandParameter="{Binding PlacementTarget.SelectedItem, RelativeSource={RelativeSource AncestorType=ContextMenu}}">
                                <MenuItem.Style>
                                    <Style TargetType="MenuItem">
                                        <Setter Property="Header" Value="Hide entry" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding PlacementTarget.SelectedItem.Entry.IsBlacklisted, RelativeSource={RelativeSource AncestorType=ContextMenu}}" Value="True">
                                                <Setter Property="Header" Value="Unhide entry" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </MenuItem.Style>
                            </MenuItem>
                        </ContextMenu>
                    </DataGrid.ContextMenu>
                    <DataGrid.ColumnHeaderStyle>
                        <Style TargetType="DataGridColumnHeader">
                            <Setter Property="Background" Value="#F9FAFB"/>
                            <Setter Property="Foreground" Value="#374151"/>
                            <Setter Property="FontSize" Value="11"/>
                            <Setter Property="FontWeight" Value="SemiBold"/>
                            <Setter Property="Height" Value="28"/>
                            <Setter Property="BorderBrush" Value="#E5E7EB"/>
                            <Setter Property="BorderThickness" Value="0,0,1,1"/>
                            <Setter Property="Padding" Value="6,0"/>
                        </Style>
                    </DataGrid.ColumnHeaderStyle>
                    <DataGrid.CellStyle>
                        <Style TargetType="DataGridCell">
                            <Setter Property="BorderThickness" Value="0"/>
                            <Setter Property="Padding" Value="4,0"/>
                            <Setter Property="FontSize" Value="11"/>
                            <Style.Triggers>
                                <Trigger Property="IsSelected" Value="True">
                                    <Setter Property="Background" Value="#EFF6FF"/>
                                    <Setter Property="Foreground" Value="#1F2937"/>
                                    <Setter Property="BorderBrush" Value="#BFDBFE"/>
                                </Trigger>
                            </Style.Triggers>
                            </Style>
                    </DataGrid.CellStyle>
                    <DataGrid.Columns>
                        <StaticResource ResourceKey="LibraryResultsColumn.AttachmentIndicator" />
                        <StaticResource ResourceKey="LibraryResultsColumn.Title" />
                        <StaticResource ResourceKey="LibraryResultsColumn.Score" />
                        <StaticResource ResourceKey="LibraryResultsColumn.Source" />
                        <StaticResource ResourceKey="LibraryResultsColumn.Type" />
                        <StaticResource ResourceKey="LibraryResultsColumn.Year" />
                        <StaticResource ResourceKey="LibraryResultsColumn.AddedOn" />
                        <StaticResource ResourceKey="LibraryResultsColumn.AddedBy" />
                        <StaticResource ResourceKey="LibraryResultsColumn.InternalId" />
                        <StaticResource ResourceKey="LibraryResultsColumn.Doi" />
                        <StaticResource ResourceKey="LibraryResultsColumn.Pmid" />
                        <StaticResource ResourceKey="LibraryResultsColumn.Nct" />
                        <StaticResource ResourceKey="LibraryResultsColumn.Authors" />
                        <StaticResource ResourceKey="LibraryResultsColumn.Tags" />
                        <StaticResource ResourceKey="LibraryResultsColumn.IsInternal" />
                        <StaticResource ResourceKey="LibraryResultsColumn.Snippet" />
                    </DataGrid.Columns>
                </DataGrid>

                <!-- Toggle Right Panel Button -->
                <ToggleButton Grid.Row="1"
                      Grid.Column="3"
                      Name="RightPanelToggle"
                      IsChecked="True"
                      HorizontalAlignment="Right"
                      VerticalAlignment="Top"
                      Width="20"
                      Height="32"
                      Padding="0"
                      Margin="2,8,2,0"
                      FontFamily="Segoe MDL2 Assets"
                      FontSize="12"
                      Background="Transparent"
                      BorderThickness="0"
                      ToolTip="Toggle right panel">
                    <ToggleButton.Style>
                        <Style TargetType="ToggleButton">
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="Content" Value="&#xE0E3;"/>
                            <Style.Triggers>
                                <Trigger Property="IsChecked" Value="False">
                                    <Setter Property="Content" Value="&#xE0E2;"/>
                                </Trigger>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#F3F4F6"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </ToggleButton.Style>
                </ToggleButton>

                <!-- Right Panel - Entry Details -->
                <Border Grid.Row="1"
                Grid.Column="4"
                Background="White"
                BorderBrush="#E5E7EB"
                BorderThickness="1,0,0,0"
                Name="RightPanelBorder">
                    <ScrollViewer VerticalScrollBarVisibility="Auto"
                        HorizontalScrollBarVisibility="Disabled">
                        <Grid>
                            <ContentPresenter x:Name="EntryDetailPresenter"
                                Content="{Binding Results.Selected}"
                                ContentTemplate="{StaticResource LibraryEntryDetailTemplate}"
                                Margin="8"/>
                            <TextBlock Text="Select an entry to view details"
                         Margin="8"
                         FontStyle="Italic"
                         Foreground="#9CA3AF"
                         TextWrapping="Wrap"
                         VerticalAlignment="Center"
                         HorizontalAlignment="Center">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Content, ElementName=EntryDetailPresenter}" Value="{x:Null}">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </Grid>
                    </ScrollViewer>
                </Border>

                <!-- Triggers for panel visibility -->
                <Grid.Triggers>
                    <EventTrigger SourceName="LeftPanelToggle" RoutedEvent="ToggleButton.Checked">
                        <BeginStoryboard>
                            <Storyboard>
                                <DoubleAnimation Storyboard.TargetName="LeftColumn" 
                                 Storyboard.TargetProperty="Width.Value"
                                 To="240" Duration="0:0:0.2"/>
                                <ObjectAnimationUsingKeyFrames Storyboard.TargetName="LeftPanelBorder"
                                                Storyboard.TargetProperty="Visibility">
                                    <DiscreteObjectKeyFrame KeyTime="0:0:0" Value="{x:Static Visibility.Visible}"/>
                                </ObjectAnimationUsingKeyFrames>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                    <EventTrigger SourceName="LeftPanelToggle" RoutedEvent="ToggleButton.Unchecked">
                        <BeginStoryboard>
                            <Storyboard>
                                <DoubleAnimation Storyboard.TargetName="LeftColumn" 
                                 Storyboard.TargetProperty="Width.Value"
                                 To="0" Duration="0:0:0.2"/>
                                <ObjectAnimationUsingKeyFrames Storyboard.TargetName="LeftPanelBorder"
                                                Storyboard.TargetProperty="Visibility">
                                    <DiscreteObjectKeyFrame KeyTime="0:0:0.2" Value="{x:Static Visibility.Collapsed}"/>
                                </ObjectAnimationUsingKeyFrames>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                    <EventTrigger SourceName="RightPanelToggle" RoutedEvent="ToggleButton.Checked">
                        <BeginStoryboard>
                            <Storyboard>
                                <DoubleAnimation Storyboard.TargetName="RightColumn" 
                                 Storyboard.TargetProperty="Width.Value"
                                 To="300" Duration="0:0:0.2"/>
                                <ObjectAnimationUsingKeyFrames Storyboard.TargetName="RightPanelBorder"
                                                Storyboard.TargetProperty="Visibility">
                                    <DiscreteObjectKeyFrame KeyTime="0:0:0" Value="{x:Static Visibility.Visible}"/>
                                </ObjectAnimationUsingKeyFrames>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                    <EventTrigger SourceName="RightPanelToggle" RoutedEvent="ToggleButton.Unchecked">
                        <BeginStoryboard>
                            <Storyboard>
                                <DoubleAnimation Storyboard.TargetName="RightColumn" 
                                 Storyboard.TargetProperty="Width.Value"
                                 To="0" Duration="0:0:0.2"/>
                                <ObjectAnimationUsingKeyFrames Storyboard.TargetName="RightPanelBorder"
                                                Storyboard.TargetProperty="Visibility">
                                    <DiscreteObjectKeyFrame KeyTime="0:0:0.2" Value="{x:Static Visibility.Collapsed}"/>
                                </ObjectAnimationUsingKeyFrames>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                </Grid.Triggers>
            </Grid>
        </UserControl>
