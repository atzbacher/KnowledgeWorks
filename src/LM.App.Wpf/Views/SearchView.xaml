<UserControl x:Class="LM.App.Wpf.Views.SearchView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:common="clr-namespace:LM.App.Wpf.Common"
             xmlns:coreModels="clr-namespace:LM.Core.Models;assembly=LM.Core"
             mc:Ignorable="d">
  <UserControl.Resources>
    <ResourceDictionary>
      <ResourceDictionary.MergedDictionaries>
        <ResourceDictionary Source="Search/SearchViewResources.xaml" />
      </ResourceDictionary.MergedDictionaries>

      <common:BooleanToOpacityConverter x:Key="AlreadyInDbOpacityConverter"
                                         TrueOpacity="1"
                                         FalseOpacity="0" />

      <DataTemplate x:Key="SearchHitPreviewTemplate" DataType="{x:Type coreModels:SearchHit}">
        <StackPanel>
          <Border Background="#FF143029"
                  CornerRadius="4"
                  Padding="8"
                  Margin="0,0,0,10">
            <Border.Style>
              <Style TargetType="Border">
                <Setter Property="Visibility" Value="Collapsed" />
                <Style.Triggers>
                  <DataTrigger Binding="{Binding AlreadyInDb}" Value="True">
                    <Setter Property="Visibility" Value="Visible" />
                  </DataTrigger>
                </Style.Triggers>
              </Style>
            </Border.Style>
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
              <TextBlock Text="&#xE73E;"
                         FontFamily="Segoe MDL2 Assets"
                         Margin="0,0,6,0"
                         Foreground="#FF34D399" />
              <TextBlock Text="Already added to your library"
                         Foreground="#FF6EE7B7"
                         FontWeight="SemiBold" />
            </StackPanel>
          </Border>

          <TextBlock Text="{Binding Title}"
                     FontSize="18"
                     FontWeight="SemiBold"
                     Foreground="{StaticResource SearchPrimaryTextBrush}"
                     TextWrapping="Wrap" />
          <TextBlock Text="{Binding Authors}"
                     Margin="0,4,0,0"
                     Foreground="{StaticResource SearchSecondaryTextBrush}"
                     TextWrapping="Wrap" />

          <StackPanel Orientation="Horizontal"
                      Margin="0,10,0,6"
                      VerticalAlignment="Center">
            <TextBlock Text="{Binding JournalOrSource}"
                       FontWeight="SemiBold"
                       Foreground="{StaticResource SearchPrimaryTextBrush}"
                       TextWrapping="Wrap" />
            <TextBlock Text="{Binding Year}"
                       Margin="8,0,0,0"
                       Foreground="{StaticResource SearchSecondaryTextBrush}" />
          </StackPanel>

          <Grid>
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto" />
              <RowDefinition Height="Auto" />
              <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="Auto" />
              <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <TextBlock Grid.Row="0"
                       Grid.Column="0"
                       Margin="0,0,8,0"
                       FontWeight="SemiBold"
                       Foreground="{StaticResource SearchSecondaryTextBrush}"
                       Text="Database" />
            <TextBlock Grid.Row="0"
                       Grid.Column="1"
                       Foreground="{StaticResource SearchPrimaryTextBrush}"
                       Text="{Binding Source}" />

            <TextBlock Grid.Row="1"
                       Grid.Column="0"
                       Margin="0,6,8,0"
                       FontWeight="SemiBold"
                       Foreground="{StaticResource SearchSecondaryTextBrush}"
                       Text="Record ID" />
            <TextBlock Grid.Row="1"
                       Grid.Column="1"
                       Margin="0,6,0,0"
                       Foreground="{StaticResource SearchPrimaryTextBrush}"
                       Text="{Binding ExternalId}" />

            <TextBlock Grid.Row="2"
                       Grid.Column="0"
                       Margin="0,6,8,0"
                       FontWeight="SemiBold"
                       Foreground="{StaticResource SearchSecondaryTextBrush}"
                       Text="DOI" />
            <TextBlock Grid.Row="2"
                       Grid.Column="1"
                       Margin="0,6,0,0"
                       Foreground="{StaticResource SearchPrimaryTextBrush}"
                       Text="{Binding Doi}" />
          </Grid>

          <TextBlock Margin="0,10,0,0"
                     Text="{Binding Url}"
                     TextWrapping="Wrap"
                     Foreground="{StaticResource SearchAccentBrush}"
                     TextDecorations="Underline" />
        </StackPanel>
      </DataTemplate>

      <DataTemplate x:Key="SearchHitPreviewPlaceholderTemplate">
        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
          <TextBlock Text="Select a result to preview"
                     FontSize="16"
                     FontWeight="SemiBold"
                     Foreground="{StaticResource SearchSecondaryTextBrush}" />
          <TextBlock Text="Choose an item from the list to see details here."
                     Margin="0,6,0,0"
                     Foreground="{StaticResource SearchSecondaryTextBrush}" />
        </StackPanel>
      </DataTemplate>

      <Style x:Key="SearchPreviewContentStyle" TargetType="ContentControl">
        <Setter Property="ContentTemplate" Value="{StaticResource SearchHitPreviewTemplate}" />
        <Style.Triggers>
          <Trigger Property="Content" Value="{x:Null}">
            <Setter Property="ContentTemplate" Value="{StaticResource SearchHitPreviewPlaceholderTemplate}" />
          </Trigger>
        </Style.Triggers>
      </Style>
    </ResourceDictionary>
  </UserControl.Resources>

  <Grid Background="{StaticResource SearchSurfaceBrush}">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
      <RowDefinition Height="Auto" />
    </Grid.RowDefinitions>

    <Border Grid.Row="0"
            Background="{StaticResource SearchPanelBrush}"
            BorderBrush="{StaticResource SearchPanelBorderBrush}"
            BorderThickness="0,0,0,1">
      <Grid Margin="12">
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="Auto" />
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>

        <StackPanel Grid.Column="0"
                    Orientation="Horizontal"
                    VerticalAlignment="Center"
                    Margin="0,0,12,0">
          <Button Command="{Binding ToggleLeftPanelCommand}"
                  AutomationProperties.Name="Toggle filter panel">
            <Button.Style>
              <Style TargetType="Button" BasedOn="{StaticResource SearchIconButtonStyle}">
                <Setter Property="Content" Value="&#xE1D1;" />
                <Setter Property="ToolTip" Value="Hide filter panel" />
                <Style.Triggers>
                  <DataTrigger Binding="{Binding IsLeftPanelCollapsed}" Value="True">
                    <Setter Property="Content" Value="&#xE1D0;" />
                    <Setter Property="ToolTip" Value="Show filter panel" />
                  </DataTrigger>
                </Style.Triggers>
              </Style>
            </Button.Style>
          </Button>
        </StackPanel>

        <Grid Grid.Column="1" VerticalAlignment="Center">
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
          </Grid.ColumnDefinitions>

          <TextBox Grid.Column="0"
                   MinHeight="32"
                   Style="{StaticResource SearchTextBoxStyle}"
                   Text="{Binding Query, UpdateSourceTrigger=PropertyChanged}"
                   ToolTip="Enter your search query" />
        </Grid>

        <StackPanel Grid.Column="2"
                    Orientation="Horizontal"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Center">
          <Button Style="{StaticResource SearchIconButtonStyle}"
                  Content="&#xE8B7;"
                  Margin="0,0,8,0"
                  Command="{Binding LoadSearchCommand}"
                  ToolTip="Load saved search"
                  AutomationProperties.Name="Load saved search" />
          <Button Style="{StaticResource SearchIconButtonStyle}"
                  Content="&#xE105;"
                  Margin="0,0,8,0"
                  Command="{Binding SaveSearchCommand}"
                  ToolTip="Save current search"
                  AutomationProperties.Name="Save current search" />
          <Button Style="{StaticResource SearchIconButtonStyle}"
                  Content="&#xEDE1;"
                  Margin="0,0,8,0"
                  Command="{Binding ExportSearchCommand}"
                  ToolTip="Export results"
                  AutomationProperties.Name="Export search results" />
          <Button Style="{StaticResource SearchAccentButtonStyle}"
                  Content="&#xE768;"
                  Margin="0,0,8,0"
                  Command="{Binding RunSearchCommand}"
                  ToolTip="Run search"
                  AutomationProperties.Name="Run search" />
          <Button Command="{Binding ToggleRightPanelCommand}"
                  AutomationProperties.Name="Toggle details panel">
            <Button.Style>
              <Style TargetType="Button" BasedOn="{StaticResource SearchIconButtonStyle}">
                <Setter Property="Content" Value="&#xE90F;" />
                <Setter Property="ToolTip" Value="Hide details panel" />
                <Style.Triggers>
                  <DataTrigger Binding="{Binding IsRightPanelCollapsed}" Value="True">
                    <Setter Property="Content" Value="&#xE1CE;" />
                    <Setter Property="ToolTip" Value="Show details panel" />
                  </DataTrigger>
                </Style.Triggers>
              </Style>
            </Button.Style>
          </Button>
        </StackPanel>
      </Grid>
    </Border>

    <Grid Grid.Row="1" Margin="12,10">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="{Binding LeftPanelWidth, Mode=TwoWay}" MinWidth="0" />
        <ColumnDefinition Width="4" />
        <ColumnDefinition Width="*" />
        <ColumnDefinition Width="4" />
        <ColumnDefinition Width="{Binding RightPanelWidth, Mode=TwoWay}" MinWidth="0" />
      </Grid.ColumnDefinitions>

      <Border Grid.Column="0"
              Background="{StaticResource SearchPanelBrush}"
              BorderBrush="{StaticResource SearchPanelBorderBrush}"
              BorderThickness="1"
              CornerRadius="4"
              Padding="{StaticResource SearchPanelPadding}">
        <Border.Style>
          <Style TargetType="Border">
            <Setter Property="Visibility" Value="Visible" />
            <Style.Triggers>
              <DataTrigger Binding="{Binding IsLeftPanelCollapsed}" Value="True">
                <Setter Property="Visibility" Value="Collapsed" />
              </DataTrigger>
            </Style.Triggers>
          </Style>
        </Border.Style>

        <ScrollViewer VerticalScrollBarVisibility="Auto">
          <StackPanel>
            <TextBlock Text="Filters"
                       Foreground="{StaticResource SearchSecondaryTextBrush}"
                       FontWeight="SemiBold"
                       FontSize="13"
                       Margin="0,0,0,12" />

            <TextBlock Text="Database"
                       Style="{StaticResource SearchSectionHeader}" />
            <ComboBox Style="{StaticResource SearchComboBoxStyle}"
                      ItemsSource="{Binding Providers.Databases}"
                      DisplayMemberPath="DisplayName"
                      SelectedValuePath="Value"
                      SelectedValue="{Binding Providers.SelectedDatabase, Mode=TwoWay}" />

            <TextBlock Text="Date range"
                       Style="{StaticResource SearchSectionHeader}"
                       Margin="0,12,0,4" />
            <StackPanel>
              <DatePicker Style="{StaticResource SearchDatePickerStyle}"
                          SelectedDate="{Binding Providers.From}" />
              <DatePicker Style="{StaticResource SearchDatePickerStyle}"
                          Margin="0,8,0,0"
                          SelectedDate="{Binding Providers.To}" />
            </StackPanel>

          </StackPanel>
        </ScrollViewer>
      </Border>

      <GridSplitter Grid.Column="1"
                    HorizontalAlignment="Stretch"
                    VerticalAlignment="Stretch"
                    ShowsPreview="True"
                    Background="{StaticResource SearchDividerBrush}">
        <GridSplitter.Style>
          <Style TargetType="GridSplitter">
            <Setter Property="Visibility" Value="Visible" />
            <Style.Triggers>
              <DataTrigger Binding="{Binding IsLeftPanelCollapsed}" Value="True">
                <Setter Property="Visibility" Value="Collapsed" />
              </DataTrigger>
            </Style.Triggers>
          </Style>
        </GridSplitter.Style>
      </GridSplitter>

      <Border Grid.Column="2"
              Background="{StaticResource SearchPanelBrush}"
              BorderBrush="{StaticResource SearchPanelBorderBrush}"
              BorderThickness="1"
              CornerRadius="4"
              Padding="0">
        <DockPanel>
          <Grid DockPanel.Dock="Top"
                Margin="12,10,12,0">
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="Auto" />
              <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>
            <TextBlock Text="Results"
                       Foreground="{StaticResource SearchPrimaryTextBrush}"
                       FontWeight="SemiBold" />
            <TextBlock Grid.Column="1"
                       HorizontalAlignment="Right"
                       Foreground="{StaticResource SearchSecondaryTextBrush}"
                       Text="{Binding Providers.Results.Count, StringFormat={}{0} matches}" />
          </Grid>

          <DataGrid Margin="12"
                    ItemsSource="{Binding Providers.Results}"
                    SelectedItem="{Binding SelectedResult, Mode=TwoWay}"
                    AutoGenerateColumns="False"
                    IsReadOnly="False"
                    CanUserAddRows="False"
                    HeadersVisibility="Column"
                    GridLinesVisibility="None"
                    RowHeaderWidth="0"
                    AlternationCount="2"
                    SelectionMode="Extended"
                    SelectionUnit="FullRow"
                    EnableRowVirtualization="True"
                    Background="Transparent"
                    Foreground="{StaticResource SearchPrimaryTextBrush}"
                    RowBackground="#FF1F242D"
                    AlternatingRowBackground="#FF1A1F27"
                    HorizontalScrollBarVisibility="Auto"
                    VerticalScrollBarVisibility="Auto">
            <DataGrid.ColumnHeaderStyle>
              <Style TargetType="DataGridColumnHeader">
                <Setter Property="Background" Value="{StaticResource SearchPanelSubtleBrush}" />
                <Setter Property="Foreground" Value="{StaticResource SearchSecondaryTextBrush}" />
                <Setter Property="BorderBrush" Value="{StaticResource SearchDividerBrush}" />
                <Setter Property="BorderThickness" Value="0,0,1,1" />
                <Setter Property="Padding" Value="6,4" />
              </Style>
            </DataGrid.ColumnHeaderStyle>
            <DataGrid.Columns>
              <DataGridCheckBoxColumn Header=""
                                       Binding="{Binding Selected, Mode=TwoWay}" Width="36" />
              <DataGridTemplateColumn Header="" Width="36">
                <DataGridTemplateColumn.CellTemplate>
                  <DataTemplate>
                    <Border Background="#FF1F6F43"
                            CornerRadius="10"
                            Width="20"
                            Height="20"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Opacity="{Binding AlreadyInDb, Converter={StaticResource AlreadyInDbOpacityConverter}}">
                      <TextBlock Text="&#xE73E;"
                                 FontFamily="Segoe MDL2 Assets"
                                 Foreground="#FF34D399"
                                 HorizontalAlignment="Center"
                                 VerticalAlignment="Center" />
                    </Border>
                  </DataTemplate>
                </DataGridTemplateColumn.CellTemplate>
              </DataGridTemplateColumn>
              <DataGridTextColumn Header="Year" Binding="{Binding Year}" Width="70" />
              <DataGridTextColumn Header="Authors" Binding="{Binding Authors}" Width="220" />
              <DataGridTextColumn Header="Title" Binding="{Binding Title}" Width="*" />
              <DataGridTextColumn Header="Source" Binding="{Binding JournalOrSource}" Width="200" />
              <DataGridTextColumn Header="DOI/ID" Binding="{Binding Doi}" Width="150" />
              <DataGridHyperlinkColumn Header="Link" Binding="{Binding Url}" Width="160" />
              <DataGridTextColumn Header="DB"
                                   Binding="{Binding AlreadyInDb}"
                                   Visibility="Collapsed" />
            </DataGrid.Columns>
          </DataGrid>
        </DockPanel>
      </Border>

      <GridSplitter Grid.Column="3"
                    HorizontalAlignment="Stretch"
                    VerticalAlignment="Stretch"
                    ShowsPreview="True"
                    Background="{StaticResource SearchDividerBrush}">
        <GridSplitter.Style>
          <Style TargetType="GridSplitter">
            <Setter Property="Visibility" Value="Visible" />
            <Style.Triggers>
              <DataTrigger Binding="{Binding IsRightPanelCollapsed}" Value="True">
                <Setter Property="Visibility" Value="Collapsed" />
              </DataTrigger>
            </Style.Triggers>
          </Style>
        </GridSplitter.Style>
      </GridSplitter>

      <Border Grid.Column="4"
              Background="{StaticResource SearchPanelBrush}"
              BorderBrush="{StaticResource SearchPanelBorderBrush}"
              BorderThickness="1"
              CornerRadius="4"
              Padding="{StaticResource SearchPanelPadding}">
        <Border.Style>
          <Style TargetType="Border">
            <Setter Property="Visibility" Value="Visible" />
            <Style.Triggers>
              <DataTrigger Binding="{Binding IsRightPanelCollapsed}" Value="True">
                <Setter Property="Visibility" Value="Collapsed" />
              </DataTrigger>
            </Style.Triggers>
          </Style>
        </Border.Style>

        <StackPanel>
          <TextBlock Text="Details"
                     Foreground="{StaticResource SearchPrimaryTextBrush}"
                     FontWeight="SemiBold" />
          <ContentControl Margin="0,12,0,0"
                          Content="{Binding SelectedResult}"
                          Style="{StaticResource SearchPreviewContentStyle}" />
        </StackPanel>
      </Border>
    </Grid>

    <Border Grid.Row="2"
            Margin="12,0,12,12"
            Background="{StaticResource SearchPanelBrush}"
            BorderBrush="{StaticResource SearchPanelBorderBrush}"
            BorderThickness="1"
            CornerRadius="4"
            Padding="12">
      <DockPanel>
        <Grid DockPanel.Dock="Top">
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
          </Grid.ColumnDefinitions>
          <TextBlock Text="Saved runs"
                     Foreground="{StaticResource SearchPrimaryTextBrush}"
                     FontWeight="SemiBold" />
          <TextBlock Grid.Column="1"
                     Margin="12,0,0,0"
                     Foreground="{StaticResource SearchSecondaryTextBrush}"
                     Text="Recent favorites and history" />
          <TextBlock Grid.Column="2"
                     Foreground="{StaticResource SearchSecondaryTextBrush}"
                     Text="{Binding PreviousRunsCount, StringFormat={}{0} total}" />
        </Grid>

        <DataGrid Margin="0,10,0,0"
                  ItemsSource="{Binding PreviousRuns}"
                  AutoGenerateColumns="False"
                  IsReadOnly="True"
                  SelectionMode="Single"
                  SelectedItem="{Binding SelectedPreviousRun, Mode=TwoWay}"
                  HeadersVisibility="Column"
                  GridLinesVisibility="None"
                  RowHeaderWidth="0"
                  AlternationCount="2"
                  Background="Transparent"
                  Foreground="{StaticResource SearchPrimaryTextBrush}"
                  RowBackground="#FF1F242D"
                  AlternatingRowBackground="#FF1A1F27">
          <DataGrid.ColumnHeaderStyle>
            <Style TargetType="DataGridColumnHeader">
              <Setter Property="Background" Value="{StaticResource SearchPanelSubtleBrush}" />
              <Setter Property="Foreground" Value="{StaticResource SearchSecondaryTextBrush}" />
              <Setter Property="BorderBrush" Value="{StaticResource SearchDividerBrush}" />
              <Setter Property="BorderThickness" Value="0,0,1,1" />
              <Setter Property="Padding" Value="6,4" />
            </Style>
          </DataGrid.ColumnHeaderStyle>
          <DataGrid.Resources>
            <Style TargetType="DataGridRow">
              <Setter Property="ContextMenu">
                <Setter.Value>
                  <ContextMenu>
                    <MenuItem Header="Show details"
                              Command="{Binding DataContext.ShowRunDetailsCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                              CommandParameter="{Binding}" />
                  </ContextMenu>
                </Setter.Value>
              </Setter>
            </Style>
          </DataGrid.Resources>
          <DataGrid.Columns>
            <DataGridTemplateColumn Header="★" Width="36">
              <DataGridTemplateColumn.CellTemplate>
                <DataTemplate>
                  <Button Command="{Binding DataContext.ToggleFavoriteCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                          CommandParameter="{Binding}"
                          Style="{StaticResource SearchIconButtonStyle}"
                          Background="Transparent"
                          BorderBrush="Transparent"
                          ToolTip="Toggle favorite">
                    <TextBlock Text="★"
                               Foreground="#FFFACC15">
                      <TextBlock.Style>
                        <Style TargetType="TextBlock">
                          <Setter Property="Opacity" Value="0.2" />
                          <Style.Triggers>
                            <DataTrigger Binding="{Binding IsFavorite}" Value="True">
                              <Setter Property="Opacity" Value="1" />
                            </DataTrigger>
                          </Style.Triggers>
                        </Style>
                      </TextBlock.Style>
                    </TextBlock>
                  </Button>
                </DataTemplate>
              </DataGridTemplateColumn.CellTemplate>
            </DataGridTemplateColumn>
            <DataGridTextColumn Header="Last"
                                 Binding="{Binding LastRunUtc, StringFormat=\{0:yyyy-MM-dd HH:mm\}}"
                                 Width="150" />
            <DataGridTextColumn Header="Provider"
                                 Binding="{Binding Provider}"
                                 Width="100" />
            <DataGridTextColumn Header="Name"
                                 Binding="{Binding DisplayName}"
                                 Width="200" />
            <DataGridTextColumn Header="Tags"
                                 Binding="{Binding TagsDisplay}"
                                 Width="200" />
            <DataGridTextColumn Header="Query"
                                 Binding="{Binding Query}"
                                 Width="*" />
            <DataGridTextColumn Header="From"
                                 Binding="{Binding LastFrom, StringFormat=\{0:yyyy-MM-dd\}}"
                                 Width="120" />
            <DataGridTextColumn Header="To"
                                 Binding="{Binding LastTo, StringFormat=\{0:yyyy-MM-dd\}}"
                                 Width="120" />
            <DataGridTextColumn Header="Total"
                                 Binding="{Binding TotalHits}"
                                 Width="80" />
            <DataGridTextColumn Header="Runs"
                                 Binding="{Binding RunCount}"
                                 Width="80" />
          </DataGrid.Columns>
        </DataGrid>
      </DockPanel>
    </Border>
  </Grid>
</UserControl>
