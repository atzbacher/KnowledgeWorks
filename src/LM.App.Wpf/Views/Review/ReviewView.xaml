<UserControl x:Class="LM.App.Wpf.Views.Review.ReviewView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:reviewVm="clr-namespace:LM.App.Wpf.ViewModels.Review"
             xmlns:reviewControls="clr-namespace:LM.App.Wpf.Views.Review.Controls"
             xmlns:reviewModels="clr-namespace:LM.Review.Core.Models;assembly=LM.Review.Core"
             xmlns:reviewAnalytics="clr-namespace:LM.Review.Core.Models.Analytics;assembly=LM.Review.Core"
             xmlns:local="clr-namespace:LM.App.Wpf.Views.Review"
             mc:Ignorable="d"
             d:DataContext="{d:DesignInstance Type=reviewVm:ReviewViewModel}">
  <UserControl.Resources>
    <ResourceDictionary>
      <ResourceDictionary.MergedDictionaries>
        <ResourceDictionary Source="/LM.App.Wpf;component/Views/Review/ReviewResources.xaml" />
      </ResourceDictionary.MergedDictionaries>
    </ResourceDictionary>
  </UserControl.Resources>

  <Grid Margin="24">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
    </Grid.RowDefinitions>

    <StackPanel Grid.Row="0">
      <TextBlock Text="Evidence review workspace"
                 FontSize="26"
                 FontWeight="SemiBold"
                 Foreground="{StaticResource ReviewCardHeaderBrush}" />
      <TextBlock Text="Navigate projects, progress assignments, and monitor quality from a single view."
                 Margin="0,6,0,0"
                 Foreground="{StaticResource ReviewCardSubduedBrush}" />
    </StackPanel>

    <Grid Grid.Row="1" Margin="0,24,0,24">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="2*" />
        <ColumnDefinition Width="*" />
      </Grid.ColumnDefinitions>

      <Border Grid.Column="0" Style="{StaticResource ReviewSectionBorderStyle}">
        <Grid>
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
          </Grid.RowDefinitions>

          <TextBlock Text="Project overview" Style="{StaticResource ReviewSectionHeaderStyle}" />
          <StackPanel Grid.Row="1" Margin="0,12,0,0">
            <StackPanel.Style>
              <Style TargetType="StackPanel">
                <Setter Property="Visibility" Value="Visible" />
                <Style.Triggers>
                  <DataTrigger Binding="{Binding Dashboard.Project}" Value="{x:Null}">
                    <Setter Property="Visibility" Value="Collapsed" />
                  </DataTrigger>
                </Style.Triggers>
              </Style>
            </StackPanel.Style>
            <TextBlock Text="{Binding Dashboard.Project.Name}" FontSize="20" FontWeight="SemiBold" />
            <TextBlock Text="{Binding Dashboard.Project.CreatedAt, StringFormat={}{0:yyyy-MM-dd}}"
                       Margin="0,6,0,0"
                       Foreground="{StaticResource ReviewCardSubduedBrush}" />
            <TextBlock Text="{Binding Dashboard.Snapshot.GeneratedAt, StringFormat={}{0:yyyy-MM-dd HH:mm}}"
                       Margin="0,6,0,0" />
            <TextBlock Text="{Binding Projects.Count, StringFormat=Total projects: {0}}"
                       Margin="0,12,0,0" />
            <TextBlock Text="{Binding Dashboard.Snapshot.StageProgress.Count, StringFormat=Stages tracked: {0}}"
                       Margin="0,4,0,0" />
          </StackPanel>

          <Border Grid.Row="2" Padding="12" CornerRadius="6" Background="#F9FAFB">
            <Border.Style>
              <Style TargetType="Border">
                <Setter Property="Visibility" Value="Collapsed" />
                <Style.Triggers>
                  <DataTrigger Binding="{Binding Dashboard.Project}" Value="{x:Null}">
                    <Setter Property="Visibility" Value="Visible" />
                  </DataTrigger>
                </Style.Triggers>
              </Style>
            </Border.Style>
            <StackPanel>
              <TextBlock Text="Choose a project to see analytics"
                         FontWeight="SemiBold"
                         Foreground="{StaticResource ReviewCardSubduedBrush}" />
              <TextBlock Text="Select from the project list below to load its dashboard."
                         Margin="0,6,0,0" />
            </StackPanel>
          </Border>
        </Grid>
      </Border>

      <Border Grid.Column="1" Margin="24,0,0,0" Style="{StaticResource ReviewSectionBorderStyle}">
        <Grid>
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
          </Grid.RowDefinitions>

          <TextBlock Text="Workflow stages" Style="{StaticResource ReviewSectionHeaderStyle}" />

          <ScrollViewer Grid.Row="1"
                        HorizontalScrollBarVisibility="Disabled"
                        VerticalScrollBarVisibility="Auto"
                        Margin="0,12,0,0"
                        CanContentScroll="True">
            <ItemsControl ItemsSource="{Binding Projects}" Margin="0">
              <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                  <VirtualizingStackPanel />
                </ItemsPanelTemplate>
              </ItemsControl.ItemsPanel>
              <ItemsControl.ItemTemplate>
                <DataTemplate DataType="{x:Type reviewModels:ReviewProject}">
                  <Button Command="{Binding DataContext.SelectProjectCommand, RelativeSource={RelativeSource AncestorType={x:Type local:ReviewView}}}"
                          CommandParameter="{Binding Id}"
                          Margin="0,0,0,8"
                          Padding="12,6"
                          HorizontalAlignment="Stretch">
                    <StackPanel Orientation="Horizontal">
                      <TextBlock Text="{Binding Name}" FontWeight="SemiBold" />
                    </StackPanel>
                  </Button>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
              <ItemsControl.Style>
                <Style TargetType="ItemsControl">
                  <Setter Property="VirtualizingStackPanel.IsVirtualizing" Value="True" />
                  <Setter Property="VirtualizingStackPanel.VirtualizationMode" Value="Recycling" />
                </Style>
              </ItemsControl.Style>
            </ItemsControl>
          </ScrollViewer>

          <ScrollViewer Grid.Row="2"
                        Margin="0,12,0,0"
                        HorizontalScrollBarVisibility="Disabled"
                        VerticalScrollBarVisibility="Auto"
                        CanContentScroll="True">
            <ItemsControl ItemsSource="{Binding Stages}">
              <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                  <VirtualizingStackPanel />
                </ItemsPanelTemplate>
              </ItemsControl.ItemsPanel>
              <ItemsControl.ItemTemplate>
                <DataTemplate DataType="{x:Type reviewModels:ReviewStage}">
                  <Button Command="{Binding DataContext.NavigateStageCommand, RelativeSource={RelativeSource AncestorType={x:Type local:ReviewView}}}"
                          CommandParameter="{Binding Id}"
                          Padding="0"
                          Margin="0,0,0,12"
                          Background="Transparent"
                          BorderThickness="0">
                    <ContentControl Content="{Binding}" ContentTemplate="{StaticResource ReviewStageSummaryTemplate}" />
                  </Button>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
              <ItemsControl.Style>
                <Style TargetType="ItemsControl">
                  <Setter Property="VirtualizingStackPanel.IsVirtualizing" Value="True" />
                  <Setter Property="VirtualizingStackPanel.VirtualizationMode" Value="Recycling" />
                </Style>
              </ItemsControl.Style>
            </ItemsControl>
          </ScrollViewer>
        </Grid>
      </Border>
    </Grid>

    <Grid Grid.Row="2">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="2*" />
        <ColumnDefinition Width="2.5*" />
        <ColumnDefinition Width="2*" />
      </Grid.ColumnDefinitions>

      <reviewControls:ScreeningQueueControl Grid.Column="0"
                                            Margin="0,0,24,0"
                                            DataContext="{Binding ScreeningQueue}" />

      <Grid Grid.Column="1">
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto" />
          <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Style="{StaticResource ReviewSectionBorderStyle}" DataContext="{Binding AssignmentDetail}">
          <Grid>
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto" />
              <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <TextBlock Text="Assignment detail" Style="{StaticResource ReviewSectionHeaderStyle}" />

            <Grid Grid.Row="1" Margin="0,12,0,0">
              <Grid.Style>
                <Style TargetType="Grid">
                  <Setter Property="Visibility" Value="Visible" />
                  <Style.Triggers>
                    <DataTrigger Binding="{Binding SelectedAssignment}" Value="{x:Null}">
                      <Setter Property="Visibility" Value="Collapsed" />
                    </DataTrigger>
                  </Style.Triggers>
                </Style>
              </Grid.Style>

              <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
              </Grid.RowDefinitions>

              <StackPanel Orientation="Horizontal">
                <reviewControls:DecisionBadge Status="{Binding SelectedAssignment.Status}" />
                <TextBlock Text="{Binding SelectedAssignment.ReviewerId}" FontSize="16" FontWeight="SemiBold" />
              </StackPanel>

              <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,8,0,0">
                <TextBlock Text="Role" FontWeight="SemiBold" />
                <TextBlock Text="{Binding SelectedAssignment.Role}" Margin="8,0,0,0" />
              </StackPanel>

              <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,8,0,0">
                <TextBlock Text="Assigned" FontWeight="SemiBold" />
                <TextBlock Text="{Binding SelectedAssignment.AssignedAt, StringFormat={}{0:yyyy-MM-dd HH:mm}}" Margin="8,0,0,0" />
              </StackPanel>

              <StackPanel Grid.Row="3" Orientation="Horizontal" Margin="0,8,0,0">
                <TextBlock Text="Completed" FontWeight="SemiBold" />
                <TextBlock Text="{Binding SelectedAssignment.CompletedAt, TargetNullValue=Pending, StringFormat={}{0:yyyy-MM-dd HH:mm}}" Margin="8,0,0,0" />
              </StackPanel>

              <StackPanel Grid.Row="4" Margin="0,12,0,0">
                <TextBlock Text="Reviewer notes" FontWeight="SemiBold" />
                <TextBox Margin="0,6,0,0"
                         TextWrapping="Wrap"
                         MinHeight="80"
                         Text="{Binding Notes, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
              </StackPanel>
            </Grid>

            <Border Grid.Row="1" Padding="12" Background="#F9FAFB" CornerRadius="6">
              <Border.Style>
                <Style TargetType="Border">
                  <Setter Property="Visibility" Value="Collapsed" />
                  <Style.Triggers>
                    <DataTrigger Binding="{Binding SelectedAssignment}" Value="{x:Null}">
                      <Setter Property="Visibility" Value="Visible" />
                    </DataTrigger>
                  </Style.Triggers>
                </Style>
              </Border.Style>
              <StackPanel>
                <TextBlock Text="Select an assignment"
                           FontWeight="SemiBold"
                           Foreground="{StaticResource ReviewCardSubduedBrush}" />
                <TextBlock Text="Pick a reviewer task from the queue to capture decisions and notes."
                           Margin="0,6,0,0" />
              </StackPanel>
            </Border>

            <StackPanel Grid.Row="1" Margin="0,12,0,0" Orientation="Horizontal" HorizontalAlignment="Right">
              <StackPanel.Style>
                <Style TargetType="StackPanel">
                  <Setter Property="Visibility" Value="Visible" />
                  <Style.Triggers>
                    <DataTrigger Binding="{Binding SelectedAssignment}" Value="{x:Null}">
                      <Setter Property="Visibility" Value="Collapsed" />
                    </DataTrigger>
                  </Style.Triggers>
                </Style>
              </StackPanel.Style>
              <Button Content="Exclude"
                      Margin="0,0,8,0"
                      Padding="16,6"
                      Command="{Binding SubmitExcludeCommand}" />
              <Button Content="Include"
                      Padding="16,6"
                      Command="{Binding SubmitIncludeCommand}" />
            </StackPanel>
          </Grid>
        </Border>

        <reviewControls:ExtractionFieldEditor Grid.Row="1"
                                              Margin="0,24,0,0"
                                              DataContext="{Binding ExtractionWorkspace}" />
      </Grid>

      <Grid Grid.Column="2" Margin="24,0,0,0">
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto" />
          <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Style="{StaticResource ReviewSectionBorderStyle}" DataContext="{Binding QualityAssurance}">
          <Grid>
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto" />
              <RowDefinition Height="Auto" />
              <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <TextBlock Text="Quality assurance" Style="{StaticResource ReviewSectionHeaderStyle}" />
            <StackPanel Grid.Row="1" Margin="0,12,0,0">
              <StackPanel.Style>
                <Style TargetType="StackPanel">
                  <Setter Property="Visibility" Value="Visible" />
                  <Style.Triggers>
                    <DataTrigger Binding="{Binding Stage}" Value="{x:Null}">
                      <Setter Property="Visibility" Value="Collapsed" />
                    </DataTrigger>
                  </Style.Triggers>
                </Style>
              </StackPanel.Style>
              <TextBlock Text="{Binding Stage.Definition.Name}" FontSize="16" FontWeight="SemiBold" />
              <TextBlock Text="{Binding ConflictState}" Margin="0,6,0,0" />
              <TextBlock Text="{Binding RequiresConsensus, StringFormat=Requires consensus: {0}}" Margin="0,6,0,0" />
              <TextBlock Text="{Binding CompletedAtUtc, TargetNullValue=Not completed, StringFormat={}{0:yyyy-MM-dd HH:mm}}" Margin="0,6,0,0" />
            </StackPanel>
            <Border Grid.Row="1" Padding="12" CornerRadius="6" Background="#F9FAFB">
              <Border.Style>
                <Style TargetType="Border">
                  <Setter Property="Visibility" Value="Collapsed" />
                  <Style.Triggers>
                    <DataTrigger Binding="{Binding Stage}" Value="{x:Null}">
                      <Setter Property="Visibility" Value="Visible" />
                    </DataTrigger>
                  </Style.Triggers>
                </Style>
              </Border.Style>
              <StackPanel>
                <TextBlock Text="QA not started"
                           FontWeight="SemiBold"
                           Foreground="{StaticResource ReviewCardSubduedBrush}" />
                <TextBlock Text="Choose a stage to review consensus status and completion details."
                           Margin="0,6,0,0" />
              </StackPanel>
            </Border>
          </Grid>
        </Border>

        <Border Grid.Row="1" Style="{StaticResource ReviewSectionBorderStyle}" DataContext="{Binding Analytics}" Margin="0,24,0,0">
          <Grid>
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto" />
              <RowDefinition Height="Auto" />
              <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <TextBlock Text="Analytics" Style="{StaticResource ReviewSectionHeaderStyle}" />
            <StackPanel Grid.Row="1" Margin="0,12,0,0">
              <StackPanel.Style>
                <Style TargetType="StackPanel">
                  <Setter Property="Visibility" Value="Visible" />
                  <Style.Triggers>
                    <DataTrigger Binding="{Binding ProjectSnapshot}" Value="{x:Null}">
                      <Setter Property="Visibility" Value="Collapsed" />
                    </DataTrigger>
                  </Style.Triggers>
                </Style>
              </StackPanel.Style>
              <TextBlock Text="{Binding ProjectSnapshot.ProjectId}" FontWeight="SemiBold" />
              <TextBlock Text="{Binding ProjectSnapshot.GeneratedAt, StringFormat={}{0:yyyy-MM-dd HH:mm}}" Margin="0,6,0,0" />
              <TextBlock Text="{Binding StageSummary.Included, StringFormat=Included: {0}}" Margin="0,12,0,0" />
              <TextBlock Text="{Binding StageSummary.Excluded, StringFormat=Excluded: {0}}" Margin="0,4,0,0" />
              <TextBlock Text="{Binding StageSummary.Pending, StringFormat=Pending: {0}}" Margin="0,4,0,0" />
            </StackPanel>

            <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled" Margin="0,12,0,0">
              <ItemsControl ItemsSource="{Binding ProjectSnapshot.StageProgress}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <VirtualizingStackPanel />
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                  <DataTemplate DataType="{x:Type reviewAnalytics:StageProgressSnapshot}">
                    <Border BorderBrush="#E5E7EB" BorderThickness="0,0,0,1" Padding="0,8,0,8">
                      <StackPanel>
                        <TextBlock Text="{Binding StageName}" FontWeight="SemiBold" />
                        <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                          <TextBlock Text="Completion" FontWeight="SemiBold" />
                          <TextBlock Text="{Binding CompletionRate, StringFormat={}{0:P0}}" Margin="8,0,0,0" />
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" Margin="0,2,0,0">
                          <TextBlock Text="Reviewers" FontWeight="SemiBold" />
                          <TextBlock Text="{Binding AverageReviewerCompletion, StringFormat={}{0:P0}}" Margin="8,0,0,0" />
                        </StackPanel>
                      </StackPanel>
                    </Border>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
                <ItemsControl.Style>
                  <Style TargetType="ItemsControl">
                    <Setter Property="VirtualizingStackPanel.IsVirtualizing" Value="True" />
                    <Setter Property="VirtualizingStackPanel.VirtualizationMode" Value="Recycling" />
                  </Style>
                </ItemsControl.Style>
              </ItemsControl>
            </ScrollViewer>

            <Border Grid.Row="2" Padding="12" Background="#F9FAFB" CornerRadius="6">
              <Border.Style>
                <Style TargetType="Border">
                  <Setter Property="Visibility" Value="Collapsed" />
                  <Style.Triggers>
                    <DataTrigger Binding="{Binding ProjectSnapshot}" Value="{x:Null}">
                      <Setter Property="Visibility" Value="Visible" />
                    </DataTrigger>
                  </Style.Triggers>
                </Style>
              </Border.Style>
              <StackPanel>
                <TextBlock Text="Analytics unavailable"
                           FontWeight="SemiBold"
                           Foreground="{StaticResource ReviewCardSubduedBrush}" />
                <TextBlock Text="Choose a project and stage to compute analytics summaries."
                           Margin="0,6,0,0" />
              </StackPanel>
            </Border>
          </Grid>
        </Border>
      </Grid>
    </Grid>
  </Grid>
</UserControl>
